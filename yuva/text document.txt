USE [GEMSEDU_MVC]
GO
/****** Object:  StoredProcedure [dbo].[sp_getRFQReport]    Script Date: 24/08/2022 12:33:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[sp_getRFQReport]
	 @P_OPERATION float(53),
	 @FromDt datetime = '',
	 @ToDt datetime= '',
	 @EVENTSTATUS varchar(max) = '',
	 @ROUND nvarchar(50) = null,
	 @PrNo varchar(max) = '',
	 @ItemAuto varchar(max) = '',
	 @UserAuto varchar(max) = '',
	 @RFQBudgetValue nvarchar(500) = null
As
Begin
	IF (@P_OPERATION = 1)
	  Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,  
		   isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE,CONVERT(varchar(10) ,Ev.ROUND ) as ROUND,
		 --  CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
			--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID ) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		 -- (select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
			--			  Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
			--			  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
			--			   THEN 'Closed'
			--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
			--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
			--	WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
			--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
			--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
   --               (
   --                  SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer
   --                  WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
   --               ) > 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
   --                  WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Partial Awarded'
   --            WHEN 
   --               (
   --                  SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
   --                  WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
   --               ) = 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
   --                  WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Awarded'
   --            ELSE Ev.CURRENTSTATUS
   --         END AS EVENTSTATUS
	   Ev.CURRENTSTATUS AS EVENTSTATUS,
	    case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
	    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME , PRNO, CLOSEDATETIME 
	 
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   Left Join (
				   Select Distinct EVENTID,pr.StoreLocation From tbl_PB_Buyer et
				   Left Join TBL_PRTransaction pr on pr.PRTRANSID = et.PRTRANSID
				   Where IsNull(pr.StoreLocation,'') != ''
	   )et on et.EVENTID = ev.EVENTID
       Left Join (
	   Select Distinct EVENTID,pr.PR_NUM as PRNO  From tbl_PB_Buyer at
	   Left Join TBL_PRMASTER pr on pr.PRID = at.PRTRANSID
	   )at on at.EVENTID = ev.EVENTID				 		 
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   order by  Ev.ENTERDATE asc
	  End

	IF (@P_OPERATION = 2)
      BEGIN 
		if(@EVENTSTATUS = 'All')
		Begin 
			Set @EVENTSTATUS = 'Published,Terminate,Extended,Closed,';
		End

		 select * from (
			Select cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME,	CONVERT(varchar(max), Ev.ROUND) as ROUND,	
				CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, FULL_NAME AS CREATEDNAME,
				--CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
				--				WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
				--  (select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
				--				  Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
				--				  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
				--				   THEN 'Closed'
				--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
				--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
				--WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
				--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminate' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
				--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
    --              (
    --                 SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
    --                 FROM tbl_PB_Buyer
    --                 WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
    --              ) > 
    --              (
    --                 SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
    --                 FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
    --                 WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
    --              ) THEN 'Partial Awarded'
    --           WHEN 
    --              (
    --                 SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
    --                 FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
    --                 WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
    --              ) = 
    --              (
    --                 SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
    --                 FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
    --                 WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
    --              ) THEN 'Awarded'
    --           ELSE Ev.CURRENTSTATUS
    --        END AS EVENTSTATUS,
	       Ev.CURRENTSTATUS AS EVENTSTATUS, 
		   case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
		  --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
		  CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDBYNAME,
		  'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME , PRNO
		  From TBL_EVENTMASTER Ev 
		  left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		  LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY	 
		  Left Join (
		  Select Distinct EVENTID,pr.StoreLocation From tbl_PB_Buyer et
		  Left Join TBL_PRTransaction pr on pr.PRTRANSID = et.PRTRANSID
		  --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID
		  Where IsNull(pr.StoreLocation,'') != ''
		  )et on et.EVENTID = ev.EVENTID	 
		  Left Join (
		  Select Distinct EVENTID,pr.PR_NUM as PRNO  From tbl_PB_Buyer at
		  Left Join TBL_PRMASTER pr on pr.PRID = at.PRTRANSID
		  ) at on at.EVENTID = ev.EVENTID				 
			)	 as x		 
		  Where x.EVENTSTATUS IN (select value from dbo.GetSplitString(@EVENTSTATUS,','))
				And (CONVERT(DATETIME,CONVERT(CHAR(10),x.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				And CONVERT(DATETIME,CONVERT(CHAR(10),x.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		
		order by  x.ENTERDATE asc
	 End
	
	IF (@P_OPERATION = 3)
    BEGIN 
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as ROUND1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 

	 -- CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2
		-- WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS
	    Ev.CURRENTSTATUS AS EVENTSTATUS,
	   case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
	   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME , PRNO,
	   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   INNER Join (
	   Select Distinct EVENTID,pr.StoreLocation From tbl_PB_Buyer et
	   Left Join TBL_PRTransaction pr on pr.PRTRANSID = et.PRTRANSID
	  -- Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID		  
	   Where IsNull(pr.StoreLocation,'') != ''
	   --and pm.PROJECT_ID in (select value from dbo.GetSplitString(@PROJECTNAME,',')) 
	   )et on et.EVENTID = ev.EVENTID
       Left Join (
	   Select Distinct EVENTID,PR_NUM as PRNO  From tbl_PB_Buyer at
	   Left Join TBL_PRMASTER pr on pr.PRID = at.PRTRANSID
	   )at on at.EVENTID = ev.EVENTID				 		 
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   ORDER BY StoreLocation
	End

	IF (@P_OPERATION = 4)
    BEGIN 
		if(@ROUND = 'All')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND) as ROUND,
				Ev.CURRENTSTATUS AS EVENTSTATUS,
				case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
			   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Left Join (
						Select Distinct EVENTID,pr.StoreLocation ,pr.PR_NUM as PRNO From tbl_PB_Buyer et
						Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
						Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
						Where IsNull(pr.StoreLocation,'') != ''
					)et on et.EVENTID = ev.EVENTID    
		   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   ORDER BY  ROUND
		End

		if(@ROUND = '1')
		Begin
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND) as ROUND,
				Ev.CURRENTSTATUS AS EVENTSTATUS,
				case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
			   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Left Join (
						Select Distinct EVENTID,pr.StoreLocation ,pr.PR_NUM as PRNO From tbl_PB_Buyer et
						Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
						Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
						Where IsNull(pr.StoreLocation,'') != ''
					)et on et.EVENTID = ev.EVENTID    
		   Where Ev.ROUND = 1
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   ORDER BY  ROUND
		End

		if(@ROUND = '>1')
		Begin
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND) as ROUND,
				Ev.CURRENTSTATUS AS EVENTSTATUS,
				case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
			   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Left Join (
						Select Distinct EVENTID,pr.StoreLocation ,pr.PR_NUM as PRNO From tbl_PB_Buyer et
						Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
						Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
						Where IsNull(pr.StoreLocation,'') != ''
					)et on et.EVENTID = ev.EVENTID    
		   Where Ev.ROUND > 1
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   ORDER BY  ROUND
		End

		if(@ROUND = '>2')
		Begin
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND) as ROUND,
				Ev.CURRENTSTATUS AS EVENTSTATUS,
				case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
			   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Left Join (
						Select Distinct EVENTID,pr.StoreLocation ,pr.PR_NUM as PRNO From tbl_PB_Buyer et
						Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
						Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
						Where IsNull(pr.StoreLocation,'') != ''
					)et on et.EVENTID = ev.EVENTID    
		   Where Ev.ROUND > 2
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   ORDER BY  ROUND
		End

		if(@ROUND = '>3')
		Begin
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND) as ROUND,
				Ev.CURRENTSTATUS AS EVENTSTATUS,
				case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
			   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Left Join (
						Select Distinct EVENTID,pr.StoreLocation ,pr.PR_NUM as PRNO From tbl_PB_Buyer et
						Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
						Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
						Where IsNull(pr.StoreLocation,'') != ''
					)et on et.EVENTID = ev.EVENTID    
		   Where Ev.ROUND > 3
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   ORDER BY  ROUND
		End

	End

	IF (@P_OPERATION = 5)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED,
		isnull(Es.AUCTION_END_DATE_TIME,'') as AUCTION_END_DATE_TIME,isnull(Es.AUCTION_START_DATE_TIME,'')as AUCTION_START_DATE_TIME,
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT(varchar(max), Ev.ROUND )as ROUND,

	 --  CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2
		-- WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS
	    Ev.CURRENTSTATUS AS EVENTSTATUS,
	   case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
	    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO 
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   inner Join (
	   Select Distinct EVENTID,pr.StoreLocation ,PR_NUM as PRNO From tbl_PB_Buyer et
	     Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	 --  Left Join TBL_SITEMASTER st on st.SiteID = pr.SiteID	   
	    --Inner join (select Distinct PrId from TBL_PRTRANSACTION Where ITEM_ID in (select value from dbo.GetSplitString(@ItemAuto,','))) llst on llst.PRID = pr.PRID		    
	   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	   Where IsNull(pr.StoreLocation,'') != '' --and st.SiteID in(select value from dbo.GetSplitString(@SiteAuto,','))
	    --and PR_STATUS in (select value from dbo.GetSplitString(@PRSTATUS,','))
		-- and PRTYPE in (select value from dbo.GetSplitString(@PRTYPE,','))
	    )et on et.EVENTID = ev.EVENTID    
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   and EVENTTYPE in(2, 3)
	   ORDER BY  ROUND
	End

	IF (@P_OPERATION = 6)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		--isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE,CONVERT (varchar(max),Ev.ROUND )as ROUND,
	   
	 --  CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
		--WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS,
	    Ev.CURRENTSTATUS AS EVENTSTATUS,
	    case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
	   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
	   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1,
	   VENDORCODE,VENDORNAME,PRIMARY_CONTACT_PERSON,MobileTelephoneNumber as PRIMARY_PHONE,OfficeEmail as EMAILID
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   left join TBL_EVENTSELECTEDUSER Eu on Eu.EVENTID =Ev.EVENTID
	   inner join TBL_VENDORMASTERNEW vn on vn.VENDORID = Eu.USERID 
	   Left Join (
	   Select Distinct EVENTID,pr.StoreLocation,PR_NUM as PRNO From tbl_PB_Buyer et
	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
	   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	   Where IsNull(pr.StoreLocation,'') != ''
	   )et on et.EVENTID = ev.EVENTID    
	   Where(CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   And  Eu.USERTYPE = 'Vendor'
	   ORDER BY  VENDORNAME
	End

	IF (@P_OPERATION = 7)
	Begin
		if(@PrNo= '' or @PrNo  is null)
		Begin 
			Set @PrNo = (SELECT STUFF
									((SELECT  ',' + CAST(etm.PRID AS NVARCHAR(50)) 
										FROM(select distinct PRID from TBL_PRMASTER) etm
                             ORDER BY PRID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @PrNo = @PrNo
		End

		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		--isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
	    isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME,CONVERT(varchar(max), Ev.ROUND )as ROUND ,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 

	 --   CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
		--WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS, 
   Ev.CURRENTSTATUS AS EVENTSTATUS,
		case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	    --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,  PRTYPE,
		'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
	    ,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD,
		(case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
	    From  TBL_EVENTMASTER Ev 
	    left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	    INNER Join (
	    Select Distinct EVENTID,PR_NUM as PRNo ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		 Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	    --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID,PRTYPE
	    Where PR.PRID in (select value from dbo.GetSplitString(@PrNo,','))
	    )et on et.EVENTID = ev.EVENTID		    
	    Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	    and    CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		order by Ev.ENTERDATE
	End

	IF (@P_OPERATION = 8)
	Begin
		if(@ItemAuto= '' or @ItemAuto  is null)
		Begin 
			Set @ItemAuto = (SELECT STUFF
									((SELECT  ',' + CAST(etm.ITEM_ID AS NVARCHAR(50)) 
										FROM(select distinct ITEM_ID from TBL_PRTransaction) etm
                             ORDER BY ITEM_ID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @ItemAuto = @ItemAuto
		End

		 Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		 --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max),Ev.ROUND )as ROUND ,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 

	 --  CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--	WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--	(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
		--	WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--	WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--	WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS, 
   Ev.CURRENTSTATUS AS EVENTSTATUS,
	   case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
	    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, 
	   FULL_NAME AS CREATEDNAME,'NA' as PONO, TBL_ItemMaster.ITEMCODE, TBL_ItemMaster.ITEMNAME as ITEMDESCRIPTION, QTY , 1 as UserValueName,
	    (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   Inner JOin tbl_PB_Buyer et on et.EVENTID = Ev.EVENTID
	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
	   Inner Join TBL_ItemMaster on TBL_ItemMaster.ItemID = pt.ITEM_ID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY	   
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and   CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103)) 
	   and   pt.ITEM_ID in (select value from dbo.GetSplitString(@ItemAuto,',')) 
	   ORDER BY ITEMCODE
	End

	IF (@P_OPERATION = 9)
	Begin
		if(@UserAuto= '' or @UserAuto  is null)
		Begin 
			Set @UserAuto = (SELECT STUFF
									((SELECT  ',' + CAST(etm.PERSON_ID AS NVARCHAR(50)) 
										FROM(select distinct PERSON_ID from TBL_USERMASTERFINAL) etm
                             ORDER BY PERSON_ID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @UserAuto = @UserAuto
		End

		 Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME,CONVERT(varchar (max), Ev.ROUND )as ROUND ,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 

			--CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
			--	WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
			--	--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
			--	) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
			--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
   --               Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
			--	  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
			--	   THEN 'Closed'
			--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
			--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
			--WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
			--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
			--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
   --               (
   --                  SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer
   --                  WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
   --               ) > 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
   --                  WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Partial Awarded'
   --            WHEN 
   --               (
   --                  SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
   --                  WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
   --               ) = 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
   --                  WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Awarded'
   --            ELSE Ev.CURRENTSTATUS
   --         END AS EVENTSTATUS,
    Ev.CURRENTSTATUS AS EVENTSTATUS,
	    case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
	   CLOSEDATETIME as BCD,   -- CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, 
	   FULL_NAME AS CREATEDNAME,'NA' as PONO,pt.ITEMCODE,pt.ITEM_DESCRIPTION as ITEMDESCRIPTION,QTY,FULL_NAME as CollaborativeUsersName , 0 as UserValueName,
	   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   Left join(
					Select * From tbl_EventSelectedUser Where USERTYPE = 'Buyer'
				)bu on bu.EVENTID = Ev.EVENTID 
	   Left join(
					Select * From tbl_EventSelectedUser Where USERTYPE = 'Technical'
				)tu on tu.EVENTID = Ev.EVENTID 
	   Inner JOin tbl_PB_Buyer et on et.EVENTID = Ev.EVENTID
	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
	   Inner JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = bu.USERID OR UN.PERSON_ID = tu.USERID
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103)) 
	   and PERSON_ID in (select value from dbo.GetSplitString(@UserAuto,',')) 
	   ORDER BY FULL_NAME
	End

	IF (@P_OPERATION = 10)
	Begin
		if(@ItemAuto= '' or @ItemAuto  is null)
		Begin 
			Set @ItemAuto = (SELECT STUFF
									((SELECT  ',' + CAST(etm.ITEM_ID AS NVARCHAR(50)) 
										FROM(select distinct ITEM_ID from TBL_PRTransaction) etm
                             ORDER BY ITEM_ID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @ItemAuto = @ItemAuto
		End

		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		--isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
		   isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, CONVERT (varchar(max), Ev.ROUND )as ROUND,

		--  CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
		--WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS,
   Ev.CURRENTSTATUS AS EVENTSTATUS,
		    case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
		   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
		   CLOSEDATETIME as BCD, FULL_NAME AS CREATEDNAME,
		   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
		   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Inner join (
			   Select Distinct EVENTID,pr.StoreLocation,PR_NUM as PRNO, pt.ITEM_ID From tbl_PB_Buyer et
			   --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
			     Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   Inner Join TBL_ItemMaster on TBL_ItemMaster.ItemID = pt.ITEM_ID
			  -- Left Join TBL_SITEMASTER st on st.SiteID = pr.SiteID	   
			   --Inner join (select Distinct PrId from TBL_PRTRANSACTION) llst on llst.PRID = pr.PRID
			   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
			   Where IsNull(pr.StoreLocation,'') != ''
			  -- and PRTYPE in (select value from dbo.GetSplitString(@PRTYPE,','))
			  -- and PR_STATUS in (select value from dbo.GetSplitString(@PRSTATUS,','))
			  -- and st.SiteID in(select value from dbo.GetSplitString(@SiteAuto,','))
			   --and pm.PROJECT_ID in(select value from dbo.GetSplitString(@ProjectId,','))
			   ) et on et.EVENTID = ev.EVENTID
		where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
		   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		   and et.ITEM_ID in (select value from dbo.GetSplitString(@ItemAuto,',')) 
		   ORDER BY ROUND 
	End

	IF (@P_OPERATION = 11)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		--isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
	     isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME,convert (varchar(max), Ev.ROUND) as Round,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 

	    CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
				WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID
				-- AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
				) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
                  Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
				  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
				   THEN 'Closed'
         WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
           (	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2
		    WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
          WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
          WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
                  (
                     SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
                     FROM tbl_PB_Buyer
                     WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
                  ) > 
                  (
                     SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
                     FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
                     WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
                  ) THEN 'Partial Awarded'
               WHEN 
                  (
                     SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
                     FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
                     WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
                  ) = 
                  (
                     SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
                     FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
                     WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
                  ) THEN 'Awarded'
               ELSE Ev.CURRENTSTATUS
            END AS EVENTSTATUS1, 
			 Ev.CURRENTSTATUS as EVENTSTATUS,
		 case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	    -- Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, PRTYPE,
		 'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
	    ,CLOSEDATETIME as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
		 CLOSEDATETIME,  0 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
		 -- REASON,rs.REASONID  ,
		(case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND
	    From  TBL_EVENTMASTER Ev 
	    left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	    INNER Join (
	    Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
			Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	    )et on et.EVENTID = ev.EVENTID				   
		--left join TBL_REASON rs on rs.REASONID = Es.REASONID
	    where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
			and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
			--- And isnull(rs.REASONID,0) > 0  
	    --ORDER BY  REASON
	End

	IF (@P_OPERATION = 12)
	Begin
		
		if(@RFQBudgetValue = 'All')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
			 Ev.CURRENTSTATUS AS EVENTSTATUS,
			case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
			,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
			 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
			  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
			From  TBL_EVENTMASTER Ev 
			left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
			 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
			INNER Join (
			Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			)et on et.EVENTID = ev.EVENTID				   
			where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
		   and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		End

		if(@RFQBudgetValue = '<5000')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
			 Ev.CURRENTSTATUS AS EVENTSTATUS,
			case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
			,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
			 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
			  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
			From  TBL_EVENTMASTER Ev 
			left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
			 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
			INNER Join (
			Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			)et on et.EVENTID = ev.EVENTID				   
			where dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) < 5000
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		End

		if(@RFQBudgetValue = '5000-10000')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
			 Ev.CURRENTSTATUS AS EVENTSTATUS,
			case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
			,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
			 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
			  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
			From  TBL_EVENTMASTER Ev 
			left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
			 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
			INNER Join (
			Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			)et on et.EVENTID = ev.EVENTID				   
			where dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) > 5000 And dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) < 10000
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		End

		if(@RFQBudgetValue = '10000-20000')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
			 Ev.CURRENTSTATUS AS EVENTSTATUS,
			case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
			,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
			 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
			  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
			From  TBL_EVENTMASTER Ev 
			left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
			 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
			INNER Join (
			Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			)et on et.EVENTID = ev.EVENTID				   
			where dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) > 10000 And dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) < 20000
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		End

		if(@RFQBudgetValue = '>20000')
		Begin 
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
			isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
			 Ev.CURRENTSTATUS AS EVENTSTATUS,
			case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
			'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
			,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
			 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
			  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
			From  TBL_EVENTMASTER Ev 
			left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
			 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
			INNER Join (
			Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			)et on et.EVENTID = ev.EVENTID				   
			where dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID)>20000 	
				and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
				and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		End
		--Else
		--Begin
		--	exec('Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,
		--		isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
		--		 Ev.CURRENTSTATUS AS EVENTSTATUS,
		--		case when Ev.EVENTTYPE = 1 then ''RFQ'' when Ev.EVENTTYPE = 2 then ''RevrAuction'' else ''FrwdAuction'' end as EVENTTYPE,
		--		''NA'' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
		--		,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	, FULL_NAME AS CREATEDNAME,
		--		 CLOSEDATETIME , 1 as TOTALRFQBUDGETValue , et.StoreLocation as PROJECTNAME ,PRNO ,
		--		  (case when Ev.EVENTTYPE = 1 then ''RFQ'' when Ev.EVENTTYPE = 2 then ''RevrAuction'' else  ''FrwdAuction'' END)  + '' '' + cast(ROUND as char) AS ROUND1
		--		From  TBL_EVENTMASTER Ev 
		--		left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		--		 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		--		INNER Join (
		--		Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		--	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
		--			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
		--		)et on et.EVENTID = ev.EVENTID
		--		where dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) ' + @RFQBudgetValue
		--	)	
	 --  End
	End

	IF (@P_OPERATION = 13)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
	    isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE,
		 
		--CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
		--		WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID 
		--		--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
		--		) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
		--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
  --                Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
		--		  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
		--		   THEN 'Closed'
		--	WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
		--	(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2 
		--	WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
		--	WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
		--	WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
  --                (
  --                   SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer
  --                   WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
  --                ) > 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
  --                   WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Partial Awarded'
  --             WHEN 
  --                (
  --                   SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
  --                   FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
  --                   WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
  --                ) = 
  --                (
  --                   SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
  --                   FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
  --                   WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
  --                ) THEN 'Awarded'
  --             ELSE Ev.CURRENTSTATUS
  --          END AS EVENTSTATUS,
  Ev.CURRENTSTATUS AS EVENTSTATUS,
		 case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	    --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
		'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
	    ,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET	,FULL_NAME AS CREATEDNAME,
		 CLOSEDATETIME, 
		 --rs.REASONID ,REASON ,PRTYPE
		  2 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
		  (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND
	    From  TBL_EVENTMASTER Ev 
	    left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	    INNER Join (
	    Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
		--PRTYPE
			   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	 --   Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
		--Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	    )et on et.EVENTID = ev.EVENTID				   
		--left join TBL_REASON rs on rs.REASONID = Es.REASONID
	    where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   --  isnull(rs.REASONID,0) > 0  And    
	   --ORDER BY  REASON 
	End

	IF (@P_OPERATION = 14)
	Begin
		 Select ProjectName, PRNo, (TBL_EventMaster.EVENTCODE) EVENTCODE, isnull(TBL_EventMaster.IS_AWARD, 0) AS IS_AWARD, 
		 --isnull(TBL_EventMaster.ISPERMITTED, 0) AS ISPERMITTED,
		   isnull(TBL_EventMaster.ISEXTEND, 0) AS ISEXTEND, TBL_EventMaster.EVENTID, TBL_EventMaster.EVENTNAME, CONVERT(varchar(max), TBL_EventMaster.ENTERDATE, 103) AS ENTERDATE, 
		   TBL_EventMaster.ROUND as ROUND1,
		   case when TBL_EventMaster.EVENTTYPE = 1 then 'RFQ' when TBL_EventMaster.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,   
		   (CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
				WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = TBL_EventMaster.EVENTID 
				--AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
				) < sysdatetime() AND 
				(
				SELECT count_big(TBL_AwardEventItem.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem 
				WHERE TBL_AwardEventItem.AWARDEVENTMAINID = TBL_EventMaster.EVENTID) = 0 THEN 'Closed'
                ELSE TBL_EventMaster.CURRENTSTATUS end ) as CURRENTSTATUS, PRNO, PROJECTNAME,
				   b.SUPPLIER_ID VENDORID, vm.VENDORCODE,vm.VENDORNAME,b.ConvertedStartTotal MIN_TOTAL,b.ConvertedPrice FINAL_TOTAL,
		b.ConvertedSave SAVING, round((100 * b.ConvertedSave) / case when b.ConvertedPrice=0 then 1 else b.ConvertedPrice end, 2) as SavingPer 
		From
		(select ProjectName, PRNo, SUPPLIER_ID,RFQID,sum(StartTotal)as StartTotal,
		sum(ConvertedStartTotal) as ConvertedStartTotal,
		sum(Total_price)as total_price,sum(ConvertedPrice)  as ConvertedPrice,
		(sum(StartTotal)-sum(Total_price)) as SaveToal,
		sum(ConvertedStartTotal)-sum(ConvertedPrice) as ConvertedSave
		from (
		select et.ProjectName, et.PRNo, r1 .SUPPLIER_ID,min(r1.EVENTID) as  RFQID, max(ps.ITEMTOTAL) as StartTotal,
		-- PROJECT_ID, 
		max(ps.ITEMTOTAL) * ISNULL(
		(SELECT top 1 [dbo].[FUN_GETCURRENCYCONVERSIONRATE] 
					(min(ps.VendorItemCurrencyId),
					EventCurrencyId, r1.EVENTID) ),1) as ConvertedStartTotal ,min(r1.TOTAL_PRICE) as TOTAL_PRICE,
					min(r1.TOTAL_PRICE) * ISNULL(--ec.ConversionRate
					(SELECT top 1 [dbo].[FUN_GETCURRENCYCONVERSIONRATE] 
					(min(ps.VendorItemCurrencyId),
					EventCurrencyId, r1.EVENTID))
					,1)  as ConvertedPrice  
		from TBL_AUC_SUPPLIER r1 
		inner Join TBL_EventMaster on TBL_EventMaster.EventID = r1.EVENTID
		left join TBL_PB_SUPPLIER ps on ps.SUPPLIER_ID =r1.SUPPLIER_ID and ps.PRTRANSID = r1.PRTRANSID and ps.EVENTID = TBL_EventMaster.EventID 
		left join TBL_CURRENCYMASTER cm on cm.CURRENCYMASTID = ps.VendorItemCurrencyId
		INNER Join (
				Select Distinct EVENTID, PR_NUM as PRNO, pr.StoreLocation as PROJECTNAME ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
				 Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
				Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
				--Where pm.PROJECT_ID in (select value from dbo.GetSplitString(@PROJECTNAME,','))  pm.PROJECT_ID, PRTYPE

	    )et on et.EVENTID = TBL_EventMaster.EVENTID						
		inner join (SELECT arfq.PRTRANSID, arfq.SUPPLIER_ID , Max(arfq.AUCID)  as AUC_ID , MAX(UPDATEID) as  UPDATEID  
				from TBL_AUC_SUPPLIER arfq 
				inner Join TBL_EventMaster  on TBL_EventMaster.EventID = arfq.EVENTID
				where UPDATEID <> 0 AND arfq.SEQUENCEID !=0
					group by arfq.PRTRANSID,arfq.SUPPLIER_ID, EventCurrencyId
				) r2 on  r2.SUPPLIER_ID = r1.SUPPLIER_ID and r2.AUC_ID = r1.AUCID
	--where r1.RFQID = @p_EventId,PROJECT_ID
		group by et.ProjectName, et.PRNo, r1.PRTRANSID,r1.SUPPLIER_ID, EventCurrencyId, r1.EVENTID 
		) a
		group by SUPPLIER_ID,RFQID,ProjectName, PRNo) b
		inner Join TBL_EventMaster  on TBL_EventMaster.EventID = b.RFQID
		inner join TBL_VENDORMASTERNEW vm on vm.VENDORID =b.SUPPLIER_ID
		where (CONVERT(DATETIME,CONVERT(CHAR(10),TBL_EventMaster.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
		 and  CONVERT(DATETIME,CONVERT(CHAR(10),TBL_EventMaster.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		--and EventType IN (2, 3)
		--and PROJECT_ID in (select value from dbo.GetSplitString(@ProjectId,',')) 
	End

	IF (@P_OPERATION = 15)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, 
		--isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED,
		UN.FULL_NAME as Created_By, 
	    isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND as Round1,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
	    Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	    --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, PRTYPE
		'NA' as PONO, PRNO,0 as PRValueApprove,PR_STATUS, DESCRIPTION
	    ,CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD , dbo.FUN_GETEVENTTOTALBUDGET(ev.EVENTID) AS TOTALRFQBUDGET,
		
		FULL_NAME AS CREATEDNAME,
		 CLOSEDATETIME, 3 as TOTALRFQBUDGETValue , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
		 -- rs.REASONID ,REASON 
	    cast(ROUND as char) AS ROUND
	    From  TBL_EVENTMASTER Ev 
	    left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		 LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	    INNER Join (
				Select Distinct EVENTID, PR_NUM as PRNo ,pr.StoreLocation ,PR_STATUS, DESCRIPTION From tbl_PB_Buyer et
				Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			    Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
				--Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
				--Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	 PRTYPE
	    )et on et.EVENTID = ev.EVENTID				   
		--left join TBL_REASON rs on rs.REASONID = Es.REASONID
	    where  --isnull(rs.REASONID,0) > 0 And
	    (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   ORDER BY CREATEDNAME 
	End

	IF (@P_OPERATION = 16)
	Begin
		if(@EVENTSTATUS = 'All')
		Begin 
			Set @EVENTSTATUS = 'Published,Terminate,Extended,Closed,';
		End

		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, convert (varchar (max), Ev.ROUND) as ROUND,
	   Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
	    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME , 
	   (SELECT STUFF((SELECT  ',' + etm.PRCODE FROM  (select distinct EVENTID,PR_NUM as PRCODE from tbl_PB_Buyer
														 Left Join TBL_PRMASTER pr on pr.PRID = tbl_PB_Buyer.PRTRANSID
													) etm WHERE  etm.EVENTID =EV.EVENTID
			ORDER BY PRCODE FOR XML PATH('')), 1, 1, '')  AS expr )
	   as PRNO, CLOSEDATETIME
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   Left Join (
	   Select Distinct EVENTID,pr.StoreLocation From tbl_PB_Buyer et
	     Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
	   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	   Where IsNull(pr.StoreLocation,'') != ''
	   )et on et.EVENTID = ev.EVENTID
       Left Join (
	   Select Distinct EVENTID,PR_NUM as PRNO  From tbl_PB_Buyer at
	   Left Join TBL_PRMASTER pr on pr.PRID = at.PRTRANSID
	   )at on at.EVENTID = ev.EVENTID		   			 		 
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	  and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	  and Ev.CURRENTSTATUS in (select value from dbo.GetSplitString(@EVENTSTATUS,','))
	  And  (Ev.EVENTTYPE ='3' Or Ev.EVENTTYPE ='2')
	End

	IF (@P_OPERATION = 17)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE,CONVERT (varchar (max), Ev.ROUND) as ROUND,
	   Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
	   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,
	   (SELECT STUFF((SELECT  ',' + etm.PRCODE FROM  (select distinct EVENTID,PR_NUM as PRCODE from tbl_PB_Buyer
														 Left Join TBL_PRMASTER pr on pr.PRID = tbl_PB_Buyer.PRTRANSID
													) etm WHERE  etm.EVENTID =EV.EVENTID
			ORDER BY PRCODE FOR XML PATH('')), 1, 1, '')  AS expr ) as  PRNO ,
	     CLOSEDATETIME, 
	   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   Left Join (
	   Select Distinct EVENTID,pr.StoreLocation From tbl_PB_Buyer et
	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
	   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	   Where IsNull(pr.StoreLocation,'') != ''
	   )et on et.EVENTID = ev.EVENTID
       Left Join (
	   Select Distinct EVENTID,PR_NUM as PRNO  From tbl_PB_Buyer at
			Left Join TBL_PRMASTER pr on pr.PRID = at.PRTRANSID
	   --Left Join TBL_PRMASTER pr on pr.PRID = at.PRID
	   )at on at.EVENTID = ev.EVENTID		   			 		 
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   And  (Ev.EVENTTYPE ='3' Or Ev.EVENTTYPE ='2')
	   Order by EVENTTYPE
	End

	IF (@P_OPERATION = 18)
	Begin
		if(@PrNo= '' or @PrNo  is null)
		Begin 
			Set @PrNo = (SELECT STUFF
									((SELECT  ',' + CAST(etm.PRID AS NVARCHAR(50)) 
										FROM(select distinct PRID from TBL_PRMASTER) etm
                             ORDER BY PRID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @PrNo = @PrNo
		End

		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD,-- isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
		   isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME,convert (varchar (max), Ev.ROUND) as ROUND,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
		   Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
		   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,PRTYPE
		    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
		   PRNO,1 as PRValueApprove
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   left Join (
		   Select Distinct EVENTID,PR_NUM as PRNo From tbl_PB_Buyer et
		   --PRTYPE
		   Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
		   Where pr.PRID in (select value from dbo.GetSplitString(@PrNo,','))
		   ) et on et.EVENTID = ev.EVENTID
		   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10), @FromDt,103),103)
		   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))	  
		   and (Ev.EVENTTYPE ='3' Or Ev.EVENTTYPE ='2')
		   --ORDER BY  PRTYPE
	End

	IF (@P_OPERATION = 19)
	Begin
		if(@ItemAuto= '' or @ItemAuto  is null)
		Begin 
			Set @ItemAuto = (SELECT STUFF
									((SELECT  ',' + CAST(etm.ITEM_ID AS NVARCHAR(50)) 
										FROM(select distinct ITEM_ID from TBL_PRTransaction) etm
                             ORDER BY ITEM_ID FOR XML PATH('')), 1, 1, ''));
		End
		Else
		Begin
			Set @ItemAuto = @ItemAuto
		End

		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, Ev.ROUND,	CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, 
	   Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
	   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, 
	   FULL_NAME AS CREATEDNAME, TBL_ItemMaster.ITEMCODE,TBL_ItemMaster.ITEMNAME as ITEMDESCRIPTION,QTY , 1 as UserValueName,At.PR_NUM as PONO
	   From  TBL_EVENTMASTER Ev 
	   left Join (
	   Select Distinct EVENTID,PR_NUM From tbl_PB_Buyer et
	   --PRTYPE
	   Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   ) At on At.EVENTID = ev.EVENTID
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   Inner JOin tbl_PB_Buyer et on et.EVENTID = Ev.EVENTID
	   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
	   Inner Join TBL_ItemMaster on TBL_ItemMaster.ItemID = pt.ITEM_ID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY	   
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
	   and   CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103)) 
	   and   pt.ITEM_ID in (select value from dbo.GetSplitString(@ItemAuto,',')) 
	   And  (Ev.EVENTTYPE ='3' Or Ev.EVENTTYPE ='2')
	   ORDER BY ITEMCODE
	End

	IF (@P_OPERATION = 20)
	Begin
		Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
       isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTID, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE, Ev.ROUND as ROUND1,
	   Ev.CURRENTSTATUS as EVENTSTATUS, case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
	   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType,
	    CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD,
	    FULL_NAME AS CREATEDNAME,	   'NA' as PONO, '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
	    cast(ROUND as char) AS ROUND,
	   VENDORCODE,VENDORNAME,PRIMARY_CONTACT_PERSON,MobileTelephoneNumber as PRIMARY_PHONE, OfficeEmail as EMAILID
	   From  TBL_EVENTMASTER Ev 
	   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
	   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
	   left join TBL_EVENTSELECTEDUSER Eu on Eu.EVENTID =Ev.EVENTID
	   left join TBL_VENDORMASTERNEW vn on vn.VENDORID = Eu.USERID 
	   Left Join (
	   Select Distinct EVENTID,pr.StoreLocation ,PR_NUM as PRNO From tbl_PB_Buyer et
			Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
	   --Left Join TBL_PRMASTER pr on pr.PRID = et.PRID
	   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
	   Where IsNull(pr.StoreLocation,'') != ''
	   )et on et.EVENTID = ev.EVENTID    
	   Where (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10), @FromDt,103),103)
	   And  CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
	   And  Eu.USERTYPE = 'Vendor' And  (Ev.EVENTTYPE ='3' Or Ev.EVENTTYPE ='2') and VENDORNAME != '' 
	   ORDER BY  VENDORNAME
	End

	IF (@P_OPERATION = 21)
	Begin
		if(@EVENTSTATUS = 'All')
		Begin 
			Set @EVENTSTATUS = 'Published,Terminate,Extended,Closed,';
		End

		select * from (
			Select ev.EVENTID,cast(Ev.EVENTCODE as char) EVENTCODE, isnull(Ev.IS_AWARD, 0) AS IS_AWARD, --isnull(Ev.ISPERMITTED, 0) AS ISPERMITTED, 
				isnull(Ev.ISEXTEND, 0) AS ISEXTEND, Ev.EVENTNAME, CONVERT(varchar(max), Ev.ENTERDATE, 103) AS ENTERDATE,convert (VARCHAR (max), Ev.ROUND) as ROUND,
		     
			--	CASE  WHEN ( SELECT TBL_EVENTSCHEDULARMASTER$2.CLOSEDATETIME FROM TBL_EVENTSCHEDULAR  AS TBL_EVENTSCHEDULARMASTER$2
			--	WHERE TBL_EVENTSCHEDULARMASTER$2.EVENTID = Ev.EVENTID
			--	-- AND TBL_EVENTSCHEDULARMASTER$2.LOG = 1
			--	) <  (SELECT top 1 CurrentDateTime FROM [dbo].[GetDatetimeByTimeZone] (
			--(select top 1 TIMEZONE from TBL_EVENTSCHEDULAR where EVENTID = Ev.EVENTID ) ) ) AND 
   --               Ev.CURRENTSTATUS != 'Terminate' AND Ev.ISEXTEND != '1' AND  Ev.CURRENTSTATUS = 'Published' 
			--	  --AND  (  SELECT count_big(TBL_AWARDEVENTFINAL.AWARDID) AS expr FROM TBL_AWARDEVENTFINAL WHERE TBL_AWARDEVENTFINAL.EVENTID = EVENT.EVENTID) = 0
			--	   THEN 'Closed'
			--WHEN  Ev.CURRENTSTATUS = 'Published' AND Ev.CURRENTSTATUS != 'Terminate' AND  Ev.ISEXTEND != '1' AND 
			--(	SELECT count_big(TBL_AWARDEVENTFINAL$2.AWARDEVENTITEM) AS expr FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$2
			-- WHERE TBL_AWARDEVENTFINAL$2.AWARDEVENTMAINID = Ev.EVENTID) = 0 THEN 'Published'
			--WHEN Ev.CURRENTSTATUS = 'Terminate' THEN 'Terminated' WHEN Ev.ISEXTEND = '1' THEN 'Extended' 
			--WHEN /*WHEN (select count(awardid) from tbl_awardeventfinal where eventid=event.eventid) >0 THEN 'Partial Awarded'*/
   --               (
   --                  SELECT sum(tbl_PB_Buyer.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer
   --                  WHERE tbl_PB_Buyer.EVENTID = Ev.EVENTID
   --               ) > 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$3.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$3
   --                  WHERE TBL_AWARDEVENTFINAL$3.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Partial Awarded'
   --            WHEN 
   --               (
   --                  SELECT sum(TBL_EVENTTRANSACTION$2.QTY) AS TOTQTY
   --                  FROM tbl_PB_Buyer  AS TBL_EVENTTRANSACTION$2
   --                  WHERE TBL_EVENTTRANSACTION$2.EVENTID = Ev.EVENTID
   --               ) = 
   --               (
   --                  SELECT sum(TBL_AWARDEVENTFINAL$4.ASSIGNQTY) AS TOTASSIGNED
   --                  FROM TBL_AwardEventItem  AS TBL_AWARDEVENTFINAL$4
   --                  WHERE TBL_AWARDEVENTFINAL$4.AWARDEVENTMAINID = Ev.EVENTID
   --               ) THEN 'Awarded'
   --            ELSE Ev.CURRENTSTATUS
   --         END AS EVENTSTATUS,
		   Ev.CURRENTSTATUS AS EVENTSTATUS,
		   case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else 'ForwardAuction' end as EVENTTYPE,
		   --Case when Ev.RFQType = 'AUC' then 'Auction' else Ev.RFQType end as RFQType, 
		   CONVERT(varchar(max), CLOSEDATETIME, 103)  as BCD, FULL_NAME AS CREATEDNAME,
		    '' as PRTYPE , IsNull(et.StoreLocation,'') as PROJECTNAME ,PRNO ,
		   (case when Ev.EVENTTYPE = 1 then 'RFQ' when Ev.EVENTTYPE = 2 then 'ReverseAuction' else  'ForwardAuction' END)  + ' ' + cast(ROUND as char) AS ROUND1
		   From  TBL_EVENTMASTER Ev 
		   left join TBL_EVENTSCHEDULAR Es on Es.EVENTID = Ev.EVENTID
		   LEFT JOIN TBL_USERMASTERFINAL UN ON UN.PERSON_ID = Ev.ENTERBY
		   Inner Join (
			   Select Distinct EVENTID,pr.StoreLocation ,PR_NUM as PRNO From tbl_PB_Buyer et
			   Left Join TBL_PRMASTER pr on pr.PRID = et.PRTRANSID
			   Left Join TBL_PRTransaction pt on pt.PRTRANSID = et.PRTRANSID
			 --  Left Join TBL_SITEMASTER st on st.SiteID = pr.SiteID	   
			   --Inner join (select Distinct PrId from TBL_PRTRANSACTION) llst on llst.PRID = pr.PRID
			   --Left Join TBL_PROJECTMASTER pm on pm.PROJECT_ID = pr.ProjectID	
			   Where IsNull(pr.StoreLocation,'') != ''
			   --and PR_STATUS in (select value from dbo.GetSplitString(@PRSTATUS,','))
			  
			   ) et on et.EVENTID = ev.EVENTID

		   and (CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) >= CONVERT(DATETIME,CONVERT(CHAR(10),@FromDt,103),103)
		   and CONVERT(DATETIME,CONVERT(CHAR(10),Ev.ENTERDATE,103),103) <= CONVERT(DATETIME,CONVERT(CHAR(10), @ToDt,103),103))
		 ) as ab where   ab.EVENTSTATUS in (select value from dbo.GetSplitString(@EventStatus,',')) 
		   ORDER BY ab.ROUND
	End
End


eprocApp.controller('MRP_DispatchEntryCtrl', function ($scope, $http, $location, $window) {
    $scope.mdlMRP_Dispatch = {};
    $scope.mdlMRP_Dispatch.lstSub = [];
    $scope.mdlMRP_Dispatch.lstPackaging = [];
    $scope.InspectionChekList = [];
    $scope.mdlMRP_Dispatch.lstCheckList = [];
    $scope.lstCheckList = [];
    var lstCheckList = [];
    var tblBillList;
    $scope.mdlMRP_Dispatch.AutoTrNo = $('#hdnMRP_AutoTrNo').val();
    $scope.IsViewMode = false;
    $scope.IsEdit = false;

    var AutoTrNoIDs = '0';
    var PackagingDelete = '0';
    var tblDispatchsub, tblWOItems, tblEmployee;
    $('#txtDate').focus();
    shortcuts.add('alt+s', function () {
        $scope.SaveMRP_DispatchData();
    });
    $scope.CurrentDate = function () {
        $http.get("/MRP_Dispatch/PageInit")
            .then(function (response) {
                $scope.mdlMRP_Dispatch.OutwardDate = response.data.OutwardDate;
                $scope.mdlMRP_Dispatch.DCDate = response.data.DCDate;
            });
    }
    $scope.UploadDoc = function () {
        $('#flAttachment').click();
    }
    $("#flAttachment").change(function (e) {
        var fileUpload = $("#flAttachment").get(0);
        var files = fileUpload.files;
        var fileData = new FormData();
        for (var i = 0; i < files.length; i++) {
            fileData.append("ProductCatalogue", files[i]);
        }

        $.ajax({
            url: "/MRP_DieMaster/FileUploadProductCatalogue",
            type: "POST",
            contentType: false,
            processData: false,
            data: fileData,
            success: function (result) {
                if (result != null) {
                    $('#btnAttachment').css('display', 'none');
                    $('#btnAttachmentCancel').css('display', 'Block');
                    $('#DMDocument').attr("href", result.FilePath);
                    $('#DMDocument').text(result.FileName);
                    $('#DMDocument').css('display', 'Block');
                    $scope.mdlMRP_Dispatch.DMCheckedDoc = result.FileName;
                    $scope.mdlMRP_Dispatch.DMCheckedPath = result.FilePath;
                }
            },
            error: function (err) {
                toastr.error(err.statusText);
            }
        });
    });

    $('#btnAttachmentCancel').click(function (e) {
        sDocrowId = $(this).closest('tr').index();
        var r = confirm("Are you sure you want to Delete ? ");
        if (r == true) {
            $('#btnAttachment').css('display', 'block');
            $('#btnAttachmentCancel').css('display', 'none');
            $('#DMDocument').css('display', 'none');
            $scope.mdlMRP_Dispatch.DMCheckedDoc = "";
            $scope.mdlMRP_Dispatch.DMCheckedPath = "";

        }
    });

    //----------------------------------Delete Sub data---------------------------------
    $scope.DeleteRow = function (item) {

        var r = confirm("Are You Sure You Want to Delete ? ");
        if (r == true) {
            AutoTrNoIDs += item.SubAutoTrNo + ',';
            $scope.mdlMRP_Dispatch.lstSub.splice($scope.mdlMRP_Dispatch.lstSub.indexOf(item), 1);
        }
    }

    //-----------------------------------------------------Party help--------------------------------------
    $scope.GetParty = function () {
        for (var i = 0; i < $('#tblParty tfoot th').length; i++) {
            if (i > 0) {
                var title = $('#tblParty tfoot th:eq(' + i + ')').text();
                $('#tblParty tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }

        tblParty = $('#tblParty').dataTable({
            'destroy': true,
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetPartyList',
            'autoWidth': false,
            "fixedHeader": {
                "header": false,
                "footer": false
            },
            "columnDefs": [
                { "width": "15px", "targets": 0 },
                { "width": "60px", "targets": 1 }
            ],
            "aoColumns": [
                {
                    "mData": "No", className: "text-center",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnmPartyId" value="' + row.PartyId + '" />' + data;
                    },
                },
                { "mData": "PartyCode", className: "text-center" },
                { "mData": "PartyName" },
            ],
        });

        $('#tblParty_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblParty_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblParty_wrapper .dataTables_filter').css('display', 'none');

        tblParty.api().columns().eq(0).each(function (colIdx) {
            $('input', tblParty.api().column(colIdx).footer()).on('change', function () {
                tblParty.api().column(colIdx).search(this.value).draw();
            });
        });
    }
    $scope.GetParty();
    $scope.SearchParty = function () {
        $("#tblParty tbody").delegate("tr", "click", function (e) {
            var rowIndex = $(this).closest('tr').index();
            $scope.mdlMRP_Dispatch.PartyAuto = $("#tblParty tbody tr:eq('" + rowIndex + "')").find("#hdnmPartyId").val();
            $scope.mdlMRP_Dispatch.Party = $("#tblParty tbody tr:eq('" + rowIndex + "') td:eq(2)").text();
            $('#PartyModal').modal('hide');
            $scope.$apply();
            return false;
        });
        tblParty.api().column().draw();
        $("#PartyModal").modal('show');
        setTimeout(function () {
            $('#tblParty_wrapper .dataTables_scrollFootInner table:eq(0) tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
        }, 500);
    }



    //-------------------------------------Employee help-----------------------
    $scope.GetEmployee = function () {
        for (var i = 0; i < $('#tblEmployee tfoot th').length; i++) {
            if (i > 0) {
                var title = $('#tblEmployee tfoot th:eq(' + i + ')').text();
                $('#tblEmployee tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }

        tblEmployee = $('#tblEmployee').dataTable({
            'destroy': true,
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetEmployeeList',
            "scrollX": true,
            "aoColumns": [
                {
                    "mData": "SrNo", className: "text-center",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnmEAutoTrNo" value="' + row.AutoTrNo + '" />' + data;
                    },
                },
                { "mData": "EmployeeCode", className: "text-center" },
                { "mData": "EmployeeName" },
            ],
        });

        $('#tblEmployee_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblEmployee_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblEmployee_wrapper .dataTables_filter').css('display', 'none');

        tblEmployee.api().columns().eq(0).each(function (colIdx) {
            $('input', tblEmployee.api().column(colIdx).footer()).on('change', function () {
                tblEmployee.api().column(colIdx).search(this.value).draw();
            });
        });
    }
    $scope.GetEmployee();

    $('#tblDispatchsub').delegate('#btnEmp', 'click', function (e) {

        var srowId = $(this).closest('tr').index();
        acsrowId = srowId;
        $("#tblEmployee tbody").delegate("tr", "click", function (e) {

            var rowIndex = $(this).closest('tr').index();
            $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#hdnmEmpSubAuto').val($("#tblEmployee tbody tr:eq('" + rowIndex + "')").find("#hdnmEAutoTrNo").val());
            $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSEmp').val($("#tblEmployee tbody tr:eq('" + rowIndex + "') td:eq(2)").text());
            if (acsrowId >= 0) {
                $scope.mdlMRP_Dispatch.lstSub[acsrowId].EmployeeAuto = $("#tblEmployee tbody tr:eq('" + rowIndex + "')").find('#hdnmEAutoTrNo').val();
                $scope.mdlMRP_Dispatch.lstSub[acsrowId].EmployeeName = $("#tblEmployee tbody tr:eq('" + rowIndex + "') td:eq(2)").text();
                $scope.$apply();
            }
            $('#EmployeeModal').modal('hide');
            return false;
        });
        tblEmployee.api().column().draw();

        $("#EmployeeModal").modal('show');
        setTimeout(function () {
            $('#tblEmployee .dataTables_scrollFootInner table:eq(0) tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
        }, 500);

    });
    //-------------------------------------WoItem help-----------------------
    $scope.GetSubItem = function () {
        if ((angular.isUndefined($scope.mdlMRP_Dispatch.PartyAuto) ? "" : $scope.mdlMRP_Dispatch.PartyAuto) == "") {
            toastr.warning('Please Select Party.');
            return false;
        }
        for (var i = 0; i < $('#tblWOItems tfoot th').length; i++) {
            if (i > 0) {
                var title = $('#tblWOItems tfoot th:eq(' + i + ')').text();
                $('#tblWOItems tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }

        var row = $scope.mdlMRP_Dispatch.lstSub;
        var AutoNo = '';
        var RMAutoNo = '';
        for (var i = 0; i < row.length; i++) {
            if ($scope.mdlMRP_Dispatch.lstSub[i].WOSubAuto > 0) {
                AutoNo += ($scope.mdlMRP_Dispatch.lstSub[i].WOSubAuto) + ',';
            }
            if ($scope.mdlMRP_Dispatch.lstSub[i].RMAuto > 0) {
                RMAutoNo += ($scope.mdlMRP_Dispatch.lstSub[i].RMAuto) + ',';
            }
        }
        var Ids = AutoNo.substring(0, AutoNo.lastIndexOf(","));
        var RMIds = RMAutoNo.substring(0, RMAutoNo.lastIndexOf(","));
        var LId = $scope.mdlMRP_Dispatch.PartyAuto;
        tblWOItems = $('#tblWOItems').dataTable({
            'destroy': true,
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetWoItemList',
            "scrollX": true,
            "fixedHeader": {
                "header": false,
                "footer": false
            },
            "fnServerParams": function (aoData) {
                aoData.push(
                    { "name": "DId", "value": Ids },
                    { "name": "LID", "value": LId },
                    { "name": "RMId", "value": RMIds },

                );
            },
            'columnDefs': [
                {
                    'targets': 0,
                    'checkboxes': {
                        'selectRow': true
                    }
                }
            ],
            "aoColumns": [
                {
                    "mData": "WOSubAuto", className: "text-center"

                },
                {
                    "mData": "WONo", className: "text-center"

                },
                {
                    "mData": "RMNo", className: "text-center"

                },
                {
                    "mData": "ItemCode",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnmWoAutoTrNo" value="' + row.WOAuto + '" />' +
                            '<input type="hidden" id="hdnmSItemAuto" value="' + row.ItemAuto + '" />' +
                            '<input type="hidden" id="hdnmUnitAuto" value="' + row.UnitAuto + '" />' + data;
                    },
                },
                { "mData": "ItemDescription" },
                { "mData": "Qty", className: "text-right" },
                { "mData": "PendingQty", className: "dt-head-center dt-body-right" },

            ],
        });

        $('#tblWOItems_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblWOItems_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblWOItems_wrapper .dataTables_filter').css('display', 'none');

        tblWOItems.api().columns().eq(0).each(function (colIdx) {
            $('input', tblWOItems.api().column(colIdx).footer()).on('change', function () {
                tblWOItems.api().column(colIdx).search(this.value).draw();
            });
        });
        $("#WOItemModal").modal('show');
    }


    $scope.GetSubDetails = function () {
        $scope.GetSubItem();
    }
    //--------------------------------------------------------add Sub Packaging--------------------------------------------------------------
    $scope.AddPackaging = function () {

        var row = $scope.mdlMRP_Dispatch.lstPackaging;
        var item = {
            PAutoTrNo: '0', MainAuto: '0', PItemAuto: '', PItemCode: '', PItemName: '', PackingType: '', PQty: ''

        }
        $scope.mdlMRP_Dispatch.lstPackaging.push(item);
    }
    //----------------------------------Delete Sub data---------------------------------
    $scope.PackagingDeleteRow = function (item) {
        var r = confirm("Are You Sure You Want to Delete ? ");
        if (r == true) {
            PackagingDelete += item.PAutoTrNo + ',';
            $scope.mdlMRP_Dispatch.lstPackaging.splice($scope.mdlMRP_Dispatch.lstPackaging.indexOf(item), 1);
        }
    }
    //-----------------------------------Sub Item help------------------------------
    $scope.GetSubSItem = function () {
        for (var i = 0; i < $('#tblItem tfoot th').length; i++) {
            if (i > 0) {
                var title = $('#tblItem tfoot th:eq(' + i + ')').text();
                $('#tblItem tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }

        tblItem = $('#tblItem').dataTable({
            'destroy': true,
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetItemList',
            "scrollX": true,
            //"fnServerParams": function (aoData) {
            //    aoData.push(
            //        { "name": "Id", "value": $scope.mdlMRP_BOMMaster.ItemAuto },
            //    );
            //},
            "aoColumns": [
                {
                    "mData": "SRNo", className: "text-center",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnmPItemAuto" value="' + row.AutoTrNo + '" />' + data;
                    },
                },
                { "mData": "ItemCode", className: "text-center" },
                { "mData": "ItemName" },
            ],
        });

        $('#tblItem_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblItem_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblItem_wrapper .dataTables_filter').css('display', 'none');

        tblItem.api().columns().eq(0).each(function (colIdx) {
            $('input', tblItem.api().column(colIdx).footer()).on('change', function () {
                tblItem.api().column(colIdx).search(this.value).draw();
            });
        });
    }
    $scope.GetSubSItem();
    $('#tblPackaging').delegate('#btnSearchItem', 'click', function (e) {
        var srowId = $(this).closest('tr').index();
        acsrowId = srowId;
        $("#tblItem tbody").delegate("tr", "click", function (e) {
            var rowIndex = $(this).closest('tr').index();
            if (acsrowId >= 0) {
                $scope.mdlMRP_Dispatch.lstPackaging[acsrowId].PItemAuto = $("#tblItem tbody tr:eq('" + rowIndex + "')").find("#hdnmPItemAuto").val();
                $scope.mdlMRP_Dispatch.lstPackaging[acsrowId].PItemCode = $("#tblItem tbody tr:eq('" + rowIndex + "') td:eq(1)").text();
                $scope.mdlMRP_Dispatch.lstPackaging[acsrowId].PItemName = $("#tblItem tbody tr:eq('" + rowIndex + "') td:eq(2)").text();
                $scope.$apply();
            }
            $('#ItemModal').modal('hide');
            return false;
        });
        tblItem.api().column().draw();
        $("#ItemModal").modal('show');
        setTimeout(function () {
            $('#tblItem tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
        }, 500);


        return false;
    });
    ////-------------------------------------Machine help-----------------------


    //$scope.GetMachineHelp = function () {
    //    for (var i = 0; i < $('#tblMachine tfoot th').length; i++) {
    //        if (i > 0) {
    //            var title = $('#tblMachine tfoot th:eq(' + i + ')').text();
    //            $('#tblMachine tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
    //        }
    //    }

    //    tblMachine = $('#tblMachine').dataTable({
    //        'destroy': true,
    //        'bProcessing': false,
    //        'bServerSide': true,
    //        'sAjaxSource': '/MRP_Dispatch/GetMachineList',
    //        "scrollX": true,
    //        "aoColumns": [
    //            {
    //                "mData": "SrNo", className: "text-center",
    //                "render": function (data, type, row, meta) {
    //                    return '<input type="hidden" id="hdnmMAutoTrNo" value="' + row.AutoTrNo + '" />' + data;
    //                },
    //            },
    //            { "mData": "MachineNo" },
    //        ],
    //    });

    //    $('#tblMachine_wrapper .dataTables_filter input').addClass("pagesize");
    //    $('#tblMachine_wrapper .dataTables_length select').addClass("pagesize");
    //    $('#tblMachine_wrapper .dataTables_filter').css('display', 'none');

    //    tblMachine.api().columns().eq(0).each(function (colIdx) {
    //        $('input', tblMachine.api().column(colIdx).footer()).on('change', function () {
    //            tblMachine.api().column(colIdx).search(this.value).draw();
    //        });
    //    });
    //}
    //$scope.GetMachineHelp();

    //$('#tblDispatchsub').delegate('#btnMachine', 'click', function (e) {

    //    var srowId = $(this).closest('tr').index();
    //    acsrowId = srowId;
    //    $("#tblMachine tbody").delegate("tr", "click", function (e) {
    //        var rowIndex = $(this).closest('tr').index();
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#hdnmMACSubAuto').val($("#tblMachine tbody tr:eq('" + rowIndex + "')").find("#hdnmMAutoTrNo").val());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSMachine').val($("#tblMachine tbody tr:eq('" + rowIndex + "') td:eq(1)").text());
    //        if (acsrowId >= 0) {
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].MachineAuto = $("#tblMachine tbody tr:eq('" + rowIndex + "')").find('#hdnmMAutoTrNo').val();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].Machine = $("#tblMachine tbody tr:eq('" + rowIndex + "') td:eq(1)").text();
    //            $scope.$apply();
    //        }

    //        $('#MachineModal').modal('hide');
    //        return false;
    //    });
    //    tblMachine.api().column().draw();

    //    $("#MachineModal").modal('show');
    //    setTimeout(function () {
    //        $('#tblMachine .dataTables_scrollFootInner table:eq(0) tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
    //    }, 500);
    //});


    //$('#tblDispatchsub').delegate('#btnSearchSItem', 'click', function (e) {
    //    var srowId = $(this).closest('tr').index();
    //    acsrowId = srowId;
    //    $("#tblWo tbody").delegate("tr", "click", function (e) {
    //        
    //        var rowIndex = $(this).closest('tr').index();
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#hdnSubGRNAutoTrNO').val($("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmSGRNAutoTrNo").val());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#hdnSubItemAuto').val($("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmSItemAuto").val());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#hdnmGRNSubAuto').val($("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmGRNSubAuto").val());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSGRNNO').val($("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(1)").text());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSGRNDate').val($("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(2)").text());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSItemCode').val($("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(3)").text());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtSItemDescription').val($("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(4)").text());
    //        $("#tblDispatchsub tbody tr:eq('" + acsrowId + "')").find('#txtGRNRecQty').val($("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(5)").text());
    //        if (acsrowId >= 0) {
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].SGRNAuto = $("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmSGRNAutoTrNo").val();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].SItemAuto = $("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmSItemAuto").val();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].GRNSubAuto = $("#tblWo tbody tr:eq('" + rowIndex + "')").find("#hdnmGRNSubAuto").val();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].GRNNo = $("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(1)").text();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].SItemCode = $("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(3)").text();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].SItemDescription = $("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(4)").text();
    //            $scope.mdlMRP_Dispatch.lstSub[acsrowId].GRNQty = $("#tblWo tbody tr:eq('" + rowIndex + "') td:eq(5)").text();
    //        }
    //        $('#GRNModal').modal('hide');
    //        return false;
    //    });
    //    tblWo.api().column().draw();
    //    $("#GRNModal").modal('show');
    //    setTimeout(function () {
    //        $('#tblWo tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
    //    }, 500);

    //    return false;
    //});

    $scope.SaveWoItemSub = function () {
        var Ids_selected = tblWOItems.api().column(0).checkboxes.selected();
        var SubAuto = '';
        var RMSubAuto = '';
        $.each(Ids_selected, function (index, rowId) {

            var myArray = rowId.split("-");
            if (myArray[0] == "RM") {
                RMSubAuto += myArray[1] + ',';
            }
            if (myArray[0] == "WO") {

                SubAuto += myArray[1] + ',';
            }
        });

        var Ids = SubAuto.substring(0, SubAuto.lastIndexOf(","));
        var RMIds = RMSubAuto.substring(0, RMSubAuto.lastIndexOf(","));

        if (Ids != '' || RMIds!="" ) {
            $.ajax({
                type: "POST",
                url: "/MRP_Dispatch/GetMultipleWOItem",
                data: "{'Ids':'" + Ids + "','RMIds':'" + RMIds + "'}",
                datatype: "json",
                contentType: "application/json; charset=utf-8",
                async: true,
                success: function (data) {

                    var result = data;
                    if (result != "") {
                        for (var i = 0; i < result.length; i++) {
                            var item = {
                                Qty: result[i].PendingQty, SItemDescription: result[i].SItemDescription, SItemCode: result[i].SItemCode,
                                SItemAuto: result[i].SItemAuto, WOSubAuto: result[i].WOSubAuto, Unit: result[i].Unit, UnitAuto: result[i].UnitAuto,
                                WOSubAuto: result[i].WOSubAuto, WONo: result[i].WONo, WOAuto: result[i].WOAuto, PendingQty: result[i].PendingQty,
                                CastingWeight: result[i].CastingWeight, TotalWeight: result[i].TotalWeight, ChekList: lstCheckList,
                                RMNo: result[i].RMNo, RMAuto: result[i].RMAuto
                            }
                            $scope.mdlMRP_Dispatch.lstSub.push(item);
                        }
                    }
                    $scope.$apply();
                }, error: function (request, status, error) {
                    toastr.error('Ajax Error : ' + request.responseText);
                }
            });
        }

        $("#WOItemModal").modal('hide');
    }

    $scope.ChekPendingQty = function (item) {

        var PendingQty = parseFloat((angular.isUndefined(item.PendingQty) ? 0 : item.PendingQty) == "" ? "0" :
            ((angular.isUndefined(item.PendingQty) ? 0 : item.PendingQty) == null ? "0"
                : (angular.isUndefined(item.PendingQty) ? 0 : item.PendingQty)));

        var Qty = parseFloat((angular.isUndefined(item.Qty) ? 0 : item.Qty) == "" ? "0" :
            ((angular.isUndefined(item.Qty) ? 0 : item.Qty) == null ? "0"
                : (angular.isUndefined(item.Qty) ? 0 : item.Qty)));

        var CastingWeight = parseFloat((angular.isUndefined(item.CastingWeight) ? 0 : item.CastingWeight) == "" ? "0" :
            ((angular.isUndefined(item.CastingWeight) ? 0 : item.CastingWeight) == null ? "0"
                : (angular.isUndefined(item.CastingWeight) ? 0 : item.CastingWeight)));

        if (PendingQty < Qty) {
            item.Qty = item.PendingQty;
            toastr.warning('Please Enter Lessthan or Equal to Pending WO Qty.');
            item.TotalWeight = parseFloat(CastingWeight * item.Qty).toFixed(2);
            return false;
        } else {
            item.TotalWeight = parseFloat(CastingWeight * Qty).toFixed(2);

        }


    }

    //----------------------- save----------------------------------------
    $scope.SaveMRP_DispatchData = function () {

        var ID = $scope.mdlMRP_Dispatch.AutoTrNo;
        $scope.mdlMRP_Dispatch.AutoTrNoIDs = AutoTrNoIDs;
        $scope.mdlMRP_Dispatch.PackagingDelete = PackagingDelete;
        $scope.mdlMRP_Dispatch.DCDate = $('#txtDate').val()
        $scope.mdlMRP_Dispatch.OutwardDate = $('#txtODate').val()

        if (angular.isUndefined($scope.mdlMRP_Dispatch.BillSeriesID) == true || $scope.mdlMRP_Dispatch.BillSeriesID == 0 || $scope.mdlMRP_Dispatch.BillSeriesID == "") {
            toastr.warning('Please Select Bill Series.');
            return false;
        }
        if (angular.isUndefined($scope.mdlMRP_Dispatch.DCDate) == true || $scope.mdlMRP_Dispatch.DCDate == '') {
            toastr.warning('Please Select DC Date.');
            return false;
        }
        if ((angular.isUndefined($scope.mdlMRP_Dispatch.PartyAuto) ? "" : $scope.mdlMRP_Dispatch.PartyAuto) == "") {
            toastr.warning('Please Select Party.');
            return false;
        }

        if ($scope.mdlMRP_Dispatch.lstClientDoc != null && $scope.mdlMRP_Dispatch.lstClientDoc.length > 0) {
            for (var i = 0; i < $scope.mdlMRP_Dispatch.lstClientDoc.length; i++) {
                $scope.mdlMRP_Dispatch.lstClientDoc[i].DocName = $('#tblClientDoc tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').prop('href');
                $scope.mdlMRP_Dispatch.lstClientDoc[i].OriginalDocName = $('#tblClientDoc tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').text();
            }
        }
        if ($scope.mdlMRP_Dispatch.lstClientIns != null && $scope.mdlMRP_Dispatch.lstClientIns.length > 0) {
            for (var i = 0; i < $scope.mdlMRP_Dispatch.lstClientIns.length; i++) {
                $scope.mdlMRP_Dispatch.lstClientIns[i].DocName = $('#tblClientIns tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').prop('href');
                $scope.mdlMRP_Dispatch.lstClientIns[i].OriginalDocName = $('#tblClientIns tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').text();
            }
        }

        if ($scope.mdlMRP_Dispatch.lstClientShipAtt != null && $scope.mdlMRP_Dispatch.lstClientShipAtt.length > 0) {
            for (var i = 0; i < $scope.mdlMRP_Dispatch.lstClientShipAtt.length; i++) {
                $scope.mdlMRP_Dispatch.lstClientShipAtt[i].DocName = $('#tblClientShipAtt tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').prop('href');
                $scope.mdlMRP_Dispatch.lstClientShipAtt[i].OriginalDocName = $('#tblClientShipAtt tbody tr:eq(' + i + ')').find('#lnkProductCatalogueName').text();
            }
        }
        var itemsRow = $('#tblDispatchsub tbody tr');
        if (itemsRow.length == 0) {
            toastr.warning('Please Insert Item.');
            return false;
        } else {

            for (var rowIndex = 0; rowIndex < itemsRow.length; rowIndex++) {
                var itemcode = $("#tblDispatchsub tbody tr:eq('" + rowIndex + "')").find("#txtSItemCode").val();
                if (itemcode == '') {
                    toastr.warning('Please Select Item.');
                    return false;
                }
            }
        }
        if (ID > 0) {
            $.ajax({
                type: "POST",
                datatype: "json",
                url: "/MRP_Dispatch/UpdateMRP_DispatchData",
                data: JSON.stringify($scope.mdlMRP_Dispatch),
                contentType: "application/json; charset=utf-8",
                async: true,
                success: function (response) {
                    $scope.result = response;
                    if ($scope.result == "Sucess") {
                        toastr.success('Update Data Successfully.');
                        window.location.href = '/MRP_Dispatch/MRP_DispatchListPage';
                    } else if ($scope.result == "0") {
                        toastr.warning('RawM aterial Master Already Exists.');
                    }
                }, error: function (request, status, error) {
                    toastr.error('Ajax Error : ' + request.responseText);
                }
            });
        } else {
            $.ajax({
                type: "POST",
                datatype: "json",
                url: "/MRP_Dispatch/SaveMRP_DispatchData",
                data: JSON.stringify($scope.mdlMRP_Dispatch),
                contentType: "application/json; charset=utf-8",
                async: true,
                success: function (response) {
                    $scope.result = response;
                    if ($scope.result == "Sucess") {
                        toastr.success('Save Data Successfully.');
                        window.location.href = '/MRP_Dispatch/MRP_DispatchListPage';
                    } else if ($scope.result == "0") {
                        toastr.warning('Raw Material Master Already Exists.');
                    }
                }, error: function (request, status, error) {
                    toastr.error('Ajax Error : ' + request.responseText);
                }
            });
        }
    }

    $scope.getParameterByName = function (name) {
        var url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    //-----------------------------------------------------------Document Attach -------------------------------------------------------------------
    $scope.GetClientDoc = function () {

        var rowCount = 0;
        var item = {};
        var row = $scope.mdlMRP_Dispatch.lstClientDoc;
        if (row == null) {
            $scope.mdlMRP_Dispatch.lstClientDoc = [];
            item = {
                AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchDocument', DocName: '', hide: true, IsViewRemove: false
            }
        }
        else {
            for (var i = 0; i <= row.length; i++) {
                rowCount++;
                item = {
                    AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchDocument', DocName: '', hide: true, IsViewRemove: false
                }
            }
        }
        $scope.mdlMRP_Dispatch.lstClientDoc.push(item);
    }

    $scope.DeleteDocClientRow = function (item) {
        var r = confirm("Are You Sure You Want to Delete ? ");
        if (r == true) {
            $scope.mdlMRP_Dispatch.lstClientDoc.splice($scope.mdlMRP_Dispatch.lstClientDoc.indexOf(item), 1);
        }
    }


    $("#tblClientDoc").delegate('#btnClientDoc', 'click', function (e) {
        $(this).parent().find('#flClientDoc').click();
    });

    var ClientDocTR;
    $("#tblClientDoc").delegate('#flClientDoc', 'change', function (e) {
        ClientDocTR = $(this).parents('tr');
        var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;

        var fileUpload = $(this).get(0);
        var files = fileUpload.files;

        var fileData = new FormData();

        for (var i = 0; i < files.length; i++) {
            fileData.append("ProductCatalogue", files[i]);
        }

        $.ajax({
            url: "/MRP_Dispatch/FileUploadProductCatalogue",
            type: "POST",
            contentType: false,
            processData: false,
            data: fileData,
            success: function (result) {
                if (result != null) {
                    ClientDocTR.find('#lnkProductCatalogueName').prop('href', result.FilePath);
                    ClientDocTR.find('#lnkProductCatalogueName').text(result.FileName);
                    ClientDocTR.find('#btnClientDocCancel').show();
                    ClientDocTR.find('#btnClientDoc').hide();
                    $scope.mdlMRP_Dispatch.lstClientDoc[IxRow].IsViewRemove = true;
                    $scope.$apply();
                }
            }
            ,
            error: function (err) {
                toastr.error(err.statusText);
            }
        });
    });

    $("#tblClientDoc").delegate('#btnClientDocCancel', 'click', function (e) {
        var r = confirm("Are you sure to delete ? ");
        if (r == true) {
            var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;
            $(this).parent().find('#lnkProductCatalogueName').prop('href', '#');
            $(this).parent().find('#lnkProductCatalogueName').text('');
            $(this).hide();
            $(this).parent().find('#btnClientDoc').show();
            $(this).parent().find('#flClientDoc').val('');
            $scope.mdlMRP_Dispatch.lstClientDoc[IxRow].hide = true;
            $scope.$apply();
        }
    });


    //-------------------------------------------------------------Insurance Attach ------------------------------------------------------
    $scope.GetClientIns = function () {


        var rowCount = 0;
        var item = {};
        var row = $scope.mdlMRP_Dispatch.lstClientIns;
        if (row == null) {
            $scope.mdlMRP_Dispatch.lstClientIns = [];
            item = {
                AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchInsurance', DocName: '', hide: true, IsViewRemove: false
            }
        }
        else {
            for (var i = 0; i <= row.length; i++) {
                rowCount++;
                item = {
                    AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchInsurance', DocName: '', hide: true, IsViewRemove: false
                }
            }
        }
        $scope.mdlMRP_Dispatch.lstClientIns.push(item);
    }

    $scope.DeleteInsClientRow = function (item) {
        var r = confirm("Are You Sure You Want to Delete ? ");
        if (r == true) {
            $scope.mdlMRP_Dispatch.lstClientIns.splice($scope.mdlMRP_Dispatch.lstClientIns.indexOf(item), 1);
        }
    }


    $("#tblClientIns").delegate('#btnClientIns', 'click', function (e) {
        $(this).parent().find('#flClientIns').click();
    });

    var ClientInsTR;
    $("#tblClientIns").delegate('#flClientIns', 'change', function (e) {
        ClientInsTR = $(this).parents('tr');
        var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;

        var fileUpload = $(this).get(0);
        var files = fileUpload.files;

        var fileData = new FormData();

        for (var i = 0; i < files.length; i++) {
            fileData.append("ProductCatalogue", files[i]);
        }

        $.ajax({
            url: "/MRP_Dispatch/FileUploadProductCatalogue",
            type: "POST",
            contentType: false,
            processData: false,
            data: fileData,
            success: function (result) {
                if (result != null) {
                    ClientInsTR.find('#lnkProductCatalogueName').prop('href', result.FilePath);
                    ClientInsTR.find('#lnkProductCatalogueName').text(result.FileName);
                    ClientInsTR.find('#btnClientInsCancel').show();
                    ClientInsTR.find('#btnClientIns').hide();
                    $scope.mdlMRP_Dispatch.lstClientIns[IxRow].IsViewRemove = true;
                    $scope.$apply();
                }
            }
            ,
            error: function (err) {
                toastr.error(err.statusText);
            }
        });
    });

    $("#tblClientIns").delegate('#btnClientInsCancel', 'click', function (e) {
        var r = confirm("Are you sure to delete ? ");
        if (r == true) {
            var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;
            $(this).parent().find('#lnkProductCatalogueName').prop('href', '#');
            $(this).parent().find('#lnkProductCatalogueName').text('');
            $(this).hide();
            $(this).parent().find('#btnClientIns').show();
            $(this).parent().find('#flClientIns').val('');
            $scope.mdlMRP_Dispatch.lstClientIns[IxRow].hide = true;
            $scope.$apply();
        }
    });



    //-------------------------------------------------------------Shipping Attach ------------------------------------------------------
    $scope.GetClientShipAtt = function () {


        var rowCount = 0;
        var item = {};
        var row = $scope.mdlMRP_Dispatch.lstClientShipAtt;
        if (row == null) {
            $scope.mdlMRP_Dispatch.lstClientShipAtt = [];
            item = {
                AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchShipping', DocName: '', hide: true, IsViewRemove: false
            }
        }
        else {
            for (var i = 0; i <= row.length; i++) {
                rowCount++;
                item = {
                    AutoTrNo: '0', Name: '', OriginalDocName: '', EntryType: 'DispatchShipping', DocName: '', hide: true, IsViewRemove: false
                }
            }
        }
        $scope.mdlMRP_Dispatch.lstClientShipAtt.push(item);
    }

    $scope.DeleteShipClientRow = function (item) {
        var r = confirm("Are You Sure You Want to Delete ? ");
        if (r == true) {
            $scope.mdlMRP_Dispatch.lstClientShipAtt.splice($scope.mdlMRP_Dispatch.lstClientShipAtt.indexOf(item), 1);
        }
    }
    $("#tblClientShipAtt").delegate('#btnClientShipAtt', 'click', function (e) {
        $(this).parent().find('#flClientShipAtt').click();
    });

    var ClientShipAttTR;
    $("#tblClientShipAtt").delegate('#flClientShipAtt', 'change', function (e) {
        ClientShipAttTR = $(this).parents('tr');
        var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;
        var fileUpload = $(this).get(0);
        var files = fileUpload.files;
        var fileData = new FormData();
        for (var i = 0; i < files.length; i++) {
            fileData.append("ProductCatalogue", files[i]);
        }
        $.ajax({
            url: "/MRP_Dispatch/FileUploadProductCatalogue",
            type: "POST",
            contentType: false,
            processData: false,
            data: fileData,
            success: function (result) {
                if (result != null) {
                    ClientShipAttTR.find('#lnkProductCatalogueName').prop('href', result.FilePath);
                    ClientShipAttTR.find('#lnkProductCatalogueName').text(result.FileName);
                    ClientShipAttTR.find('#btnClientShipAttCancel').show();
                    ClientShipAttTR.find('#btnClientShipAtt').hide();
                    $scope.mdlMRP_Dispatch.lstClientShipAtt[IxRow].IsViewRemove = true;
                    $scope.$apply();
                }
            }
            ,
            error: function (err) {
                toastr.error(err.statusText);
            }
        });
    });

    $("#tblClientShipAtt").delegate('#btnClientShipAttCancel', 'click', function (e) {
        var r = confirm("Are you sure to delete ? ");
        if (r == true) {
            var IxRow = $(this).closest('td').parent()[0].sectionRowIndex;
            $(this).parent().find('#lnkProductCatalogueName').prop('href', '#');
            $(this).parent().find('#lnkProductCatalogueName').text('');
            $(this).hide();
            $(this).parent().find('#btnClientShipAtt').show();
            $(this).parent().find('#flClientShipAtt').val('');
            $scope.mdlMRP_Dispatch.lstClientShipAtt[IxRow].hide = true;
            $scope.$apply();
        }
    });
    //-----------------------------------------Edit------------------------------------
    $scope.GetMRP_DispatchById = function () {
        var Id = $scope.mdlMRP_Dispatch.AutoTrNo;
        $http({
            method: "post",
            url: "/MRP_Dispatch/GetMRP_DispatchById",
            datatype: "json",
            data: "{Id : " + Id + " }",
        }).then(function (response) {

            var result = response.data;
            $scope.mdlMRP_Dispatch = result[0];
            $scope.mdlMRP_Dispatch.lstSub = result[0].lstSub;
            $scope.mdlMRP_Dispatch.lstPackaging = result[0].lstPackaging;

            $scope.IsEdit = true;
            if (IsView == "1") {
                $("#divIsView :input").prop("disabled", true);
                $scope.IsViewMode = true;
            } else {
                $('#btnSearchWoNo').prop('disabled', true);
                $scope.IsViewMode = false;
            }
        })
    }

    var IsView = $scope.getParameterByName('IsView');
    var Id = $scope.getParameterByName('Id');
    if (parseFloat(Id) > 0) {
        $scope.mdlMRP_Dispatch.AutoTrNo = Id;
        var x = setInterval(function () {
            $scope.GetMRP_DispatchById();
            clearInterval(x);
        }, 200);
    }
    else {
        $scope.CurrentDate();
    }

    //////////////////////////  Proccess


    $scope.GetProcess = function () {
        for (var i = 0; i < $('#tblProcess tfoot th').length; i++) {
            if (i > 0) {
                var title = $('#tblProcess tfoot th:eq(' + i + ')').text();
                $('#tblProcess tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }
        tblProcess = $('#tblProcess').dataTable({
            'destroy': true,
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetProcessData',
            'autoWidth': false,
            "fixedHeader": {
                "header": false,
                "footer": false
            },
            "aoColumns": [
                {
                    "mData": "SrNo", className: "text-center",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnId" value="' + row.AutoTrNo + '" />' + data;
                    },
                },
                { "mData": "ProcessCode", className: "text-center" },
                { "mData": "ProcessName" },
            ],
        });
        $('#tblProcess_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblProcess_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblProcess_wrapper .dataTables_filter').css('display', 'none');
        tblProcess.api().columns().eq(0).each(function (colIdx) {
            $('input', tblProcess.api().column(colIdx).footer()).on('change', function () {
                tblProcess.api().column(colIdx).search(this.value).draw();
            });
        });
    }
    $scope.GetProcess();
    $scope.SearchProcess = function () {
        $("#tblProcess tbody").delegate("tr", "click", function (e) {
            var rowIndex = $(this).closest('tr').index();
            $scope.mdlMRP_Dispatch.ProcessAuto = $("#tblProcess tbody tr:eq('" + rowIndex + "')").find("#hdnId").val();
            $scope.mdlMRP_Dispatch.ProcessCode = $("#tblProcess tbody tr:eq('" + rowIndex + "') td:eq(1)").text();
            $scope.mdlMRP_Dispatch.ProcessName = $("#tblProcess tbody tr:eq('" + rowIndex + "') td:eq(2)").text();
            $scope.getCheklist($scope.mdlMRP_Dispatch.ProcessAuto);
            $scope.$apply();
            $('#ProcessModal').modal('hide');
            return false;
        });
        tblProcess.api().column().draw();

        $("#ProcessModal").modal('show');
        setTimeout(function () {
            $('#tblProcess_wrapper .dataTables_scrollFootInner table:eq(0) tfoot tr:eq(0) th:eq(1)').find('input[type=text]').focus();
        }, 500);
    }

    $scope.getCheklist = function (Id) {

        $http({
            method: "post",
            url: "/MRP_Dispatch/getCheklist",
            datatype: "json",
            data: "{Id : " + Id + " }",
        }).then(function (response) {
            var result = response.data;
            lstCheckList = result;
            $scope.mdlMRP_Dispatch.lstCheckList = result;
            if ($scope.mdlMRP_Dispatch.lstSub.length > 0) {

                for (var i = 0; i < $scope.mdlMRP_Dispatch.lstSub.length; i++) {
                    $scope.mdlMRP_Dispatch.lstSub[i].ChekList = lstCheckList;
                }
                $scope.$apply();
            }

        })
    }

    $scope.getCheklistUpdatetime = function (Id) {
        $http({
            method: "post",
            url: "/MRP_Dispatch/getCheklist",
            datatype: "json",
            data: "{Id : " + Id + " }",
        }).then(function (response) {
            var result = response.data;
            lstCheckList = result;
            $scope.mdlMRP_Dispatch.lstCheckList = result;
        })
    }

    $scope.CheckList = function (index) {
        $scope.ChekListIndex = index;
        var lst = $scope.mdlMRP_Dispatch.lstSub[$scope.ChekListIndex].ChekList;
        var itemsRow = $('#tblOCChekList tbody tr').remove();;
        for (var i = 0; i < lst.length; i++) {
            var isCheck = ""; var isCheckDis = "";
            if (lst[i].IsChecked == true) {
                isCheck = "checked";
            }
            if ($scope.IsViewMode == true) {
                isCheckDis = "disabled";
            }
            $("<tr role='row' class='odd'>"
                + "<td style='min-width:230px;'><input type='Text' class='form-control' id='txtCheckListDesc' value='" + lst[i].CheckListDesc + "' disabled autocomplete='off' placeholder='Party Name'>"
                + "<input type='hidden' id='hdnCheckListAuto' value='" + lst[i].CheckListAuto + "'/>"
                + "<input type='hidden' id='hdnSubAuto' value='" + lst[i].SubAuto + "' />"
                + "<input type='hidden' id='hdnProcessAuto' value='" + lst[i].ProcessAuto + "' />"
                + "<input type='hidden' id='hdnMainAuto' value='" + lst[i].MainAuto + "'/>"
                + "<input type='hidden' id='hdnAutoTrNo' value='" + lst[i].AutoTrNo + "'/>"
                + "</td>"
                + "<td align='center' style='min-width:80px;'><label class='checkbox checkbox-outline-primary'   style='margin-top:6px'><input  " + isCheckDis + " type='checkbox' id='chkIsChecked' " + isCheck + "/><span class='checkmark' ></span></label></td>"
                + "</tr>").appendTo('#tblOCChekList > tbody');
        }
        $("#OCCheckListModal").modal('show');
    };
    $scope.SaveCheckList = function () {
        var itemsRow = $('#tblOCChekList tbody tr');
        if (itemsRow.length > 0) {
            $scope.mdlMRP_Dispatch.lstSub[$scope.ChekListIndex].ChekList = [];
            for (var rowIndex = 0; rowIndex < itemsRow.length; rowIndex++) {
                var hdnCheckListAuto = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#hdnCheckListAuto").val();
                var hdnSubAuto = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#hdnSubAuto").val();
                var hdnProcessAuto = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#hdnProcessAuto").val();
                var hdnMainAuto = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#hdnMainAuto").val();
                var hdnAutoTrNo = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#hdnAutoTrNo").val();
                var txtCheckListDesc = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#txtCheckListDesc").val();
                var chkIsChecked = $("#tblOCChekList tbody tr:eq('" + rowIndex + "')").find("#chkIsChecked").is(':checked');
                var objItem = {
                    CheckListDesc: txtCheckListDesc,
                    CheckListAuto: hdnCheckListAuto,
                    SubAuto: hdnSubAuto,
                    ProcessAuto: hdnProcessAuto,
                    MainAuto: hdnMainAuto,
                    AutoTrNo: hdnAutoTrNo,
                    IsChecked: chkIsChecked

                }
                $scope.mdlMRP_Dispatch.lstSub[$scope.ChekListIndex].ChekList.push(objItem);
            }
            $scope.$apply();
        }

        // $scope.mdlMRP_Inspection.lstSub[$scope.ChekListIndex].ChekList = $scope.InspectionChekList;
        $("#OCCheckListModal").modal('hide');
    }

    $scope.WOCheckList = function (index) {
        debugger
        $scope.lstCheckList = $scope.mdlMRP_Dispatch.lstCheckList;
        $("#OCCheckListModal").modal('show');

    };
    ///////////////////////////////////bill no get
    $scope.GettblBillList = function () {
        for (var i = 0; i < $('#tblBillList tfoot th').length; i++) {
            if (i == 1 || i == 2 || i == 3 || i == 4) {
                var title = $('#tblBillList tfoot th:eq(' + i + ')').text();
                $('#tblBillList tfoot th:eq(' + i + ')').html('<input type="text" class="form-control" placeholder="' + title + '" />');
            }
        }

        tblBillList = $('#tblBillList').dataTable({
            'bProcessing': false,
            'bServerSide': true,
            'sAjaxSource': '/MRP_Dispatch/GetBillMasterList',
            "columnDefs": [
                { "width": "15px", "targets": 0 },
                { "width": "80px", "targets": 2 },
            ],
            "aoColumns": [
                {
                    "mData": "SRNO", className: "dt-head-center dt-body-center",
                    "render": function (data, type, row, meta) {
                        return '<input type="hidden" id="hdnAutoTrNo" value="' + row.AutoTrNo + '" /><input type="hidden" id="hdnNo" value="' + row.LastNo + '" />' + data;
                    },
                },
                { "mData": "EntryType", className: "dt-head-center dt-body-center" },
        
                { "mData": "LastNo", className: "dt-head-center dt-body-center" },
            ],
        });

        $('#tblBillList_wrapper .dataTables_filter input').addClass("pagesize");
        $('#tblBillList_wrapper .dataTables_length select').addClass("pagesize");
        $('#tblBillList_wrapper .dataTables_filter').css('display', 'none');

        tblBillList.api().columns().eq(0).each(function (colIdx) {
            $('input', tblBillList.api().column(colIdx).footer()).on('change', function () {
                tblBillList.api().column(colIdx).search(this.value).draw();
            });
        });
    }
    $scope.GettblBillList();
    $scope.selectBillSeries = function () {
        tblBillList.api().column().draw();
        $("#BillListModal").modal('show');
    }
    $("#tblBillList tbody").delegate("tr", "click", function (e) {
        var rowIndex = $(this).closest('tr').index();
        $('#hdnBillSeriesID').val($("#tblBillList tbody tr:eq('" + rowIndex + "')").find("#hdnAutoTrNo").val());
        $('#txtBillSeries').val($("#tblBillList tbody tr:eq('" + rowIndex + "') td:eq(1)").text());
        $scope.mdlMRP_Dispatch.BillSeriesID= $("#tblBillList tbody tr:eq('" + rowIndex + "')").find("#hdnAutoTrNo").val();
        $scope.mdlMRP_Dispatch.BillSeries = $("#tblBillList tbody tr:eq('" + rowIndex + "') td:eq(1)").text();

        var No = $("#tblBillList tbody tr:eq('" + rowIndex + "')").find("#hdnNo").val();
        var SeriesNo = String(parseInt(No == "" ? "0" : No) + 1);
        switch (SeriesNo.length) {
            case 1:
                SeriesNo = "0000" + SeriesNo;
                break;
            case 2:
                SeriesNo = "000" + SeriesNo;
                break;
            case 3:
                SeriesNo = "00" + SeriesNo;
                break;
            case 4:
                SeriesNo = "0" + SeriesNo;
                break;

            default:
                break;
        }
        var GenrateNo = $("#tblBillList tbody tr:eq('" + rowIndex + "') td:eq(1)").text() + '/' + SeriesNo;
        $("#txtDocNo").val(GenrateNo);
        $scope.mdlMRP_Dispatch.DCNo = GenrateNo;
     
        $('#BillListModal').modal('hide');
        return false;
    });

});


@{
    ViewBag.Title = "MRP_DispatchEntryPage";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<script src="~/AppJS/MRP_DispatchEntryCtrl.js"></script>
<script type="text/javascript">
    var menuTime = setTimeout(function () {
        $('.nav-item').removeClass('menu-is-opening menu-open');
        $('#LI89').addClass('menu-is-opening menu-open');
        $('#LI175').addClass('menu-is-opening menu-open');
        $('.nav-link').removeClass('active');
        $('#A1228').addClass('active');
        clearInterval(menuTime);
    }, 500);
</script>
<div ng-controller="MRP_DispatchEntryCtrl" class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-6">
                    <h5>Dispatch</h5>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item"><a href="/MRP_Dispatch/MRP_DispatchListPage">Dispatch List</a></li>
                        <li class="breadcrumb-item active">Dispatch</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>
    <section class="content">
        <div class="card">
            <div class="container-fluid">
                <div class="row float-right mt-1 mr-1">
                    <a href="/MRP_Dispatch/MRP_DispatchListPage" class="btn btn-secondary" id="btnBack" style=" margin-right: 8px;">Back</a>
                    <button type="button" id="btnAccountEntry" ng-click="SaveMRP_DispatchData()" ng-hide="IsViewMode" class="btn btn-primary">Save</button>
                </div>
            </div>
            <div class="card-action">
                <div class="bg-gray-200 nav-bg">
                    <nav class="nav nav-tabs">
                        <a class="nav-link active" data-toggle="tab" id="MainDetails" href="#tabMainDetails" style="font-size: larger; font-weight: bold; color: #640101 !important;">Main Details </a>
                        <a class="nav-link" data-toggle="tab" href="#tabDoc" style="font-size: larger; font-weight: bold; color: #640101 !important;">Document Attachment</a>
                        <a class="nav-link" data-toggle="tab" href="#tabIns" style="font-size: larger; font-weight: bold; color: #640101 !important;">Insurance Attachment</a>
                        <a class="nav-link" data-toggle="tab" href="#tabShip" style="font-size: larger; font-weight: bold; color: #640101 !important;">Shipping Attachment</a>
                        <a class="nav-link" data-toggle="tab" href="#tabPack" style="font-size: larger; font-weight: bold; color: #640101 !important;">Packing List</a>
                        <a class="nav-link" data-toggle="tab" href="#tabTrnspo" style="font-size: larger; font-weight: bold; color: #640101 !important;">Transportation</a>
                    </nav>
                </div>
            </div>

            <div class="card-body">
                <div class="card-body tab-content">
                    <div class="tab-pane active" id="tabMainDetails">
                        <div class="form-group row">
                            <input type="hidden" id="hdnMRP_AutoTrNo" ng-model="mdlMRP_Dispatch.AutoTrNo" />

                            <label id="lblBillSeries" class="col-md-1 control-label">Bill Series<span style="color: red;">*</span></label>
                            <div class="col-md-2">
                                <span class="input-group">
                                    <input type="text" ng-model="mdlMRP_Dispatch.BillSeries" id="txtBillSeries" class="form-control" placeholder="Bill Series" autocomplete="off" disabled="disabled" />
                                    <input type="hidden" id="hdnBillSeriesID" ng-model="mdlMRP_Dispatch.BillSeriesID" />
                                    <span>
                                        <button ng-click="selectBillSeries();" ng-hide="IsEdit" type="button" id="btnselectBillSeries" class="btn btn-primary pull-right"  style="padding: 3.5px 10px;"><i class="fa fa-search"></i></button>
                                    </span>
                                </span>
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">DC No<span style="color:red">*</span></label>
                            <div class="col-md-3">
                                <input type="text" id="txtDocNo" ng-model="mdlMRP_Dispatch.DCNo" class="form-control" placeholder="DC NO" autocomplete="off" disabled="disabled" />
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">DC Date<span style="color:red">*</span></label>
                            <div class="col-md-2">
                                <input type="text" id="txtDate" ng-model="mdlMRP_Dispatch.DCDate" ng-disabled='IsViewMode' style="text-align:center;" class="form-control" placeholder="DC DATE" autocomplete="off" />
                            </div>
                           
                        </div>
                        <div class="form-group row">
                            <label id="lblitem" class="col-md-1 control-label">Party<span style="color:red">*</span></label>
                            <div class="col-md-3">
                                <span class="input-group">
                                    <input type="text" id="txtParty" ng-model="mdlMRP_Dispatch.Party" class="form-control" placeholder="PARTY" autocomplete="off" disabled="disabled" />
                                    <span>
                                        <button ng-click="SearchParty()" ng-hide="IsViewMode" tabindex="2" type="button" id="btnParty" class="btn btn-primary pull-right" style="padding: 3.5px 10px;"><i class="fa fa-search"></i></button>
                                    </span>
                                    <input type="hidden" id="hdnPartyId" ng-model="mdlMRP_Dispatch.PartyAuto" />
                                </span>
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">Process Code</label>
                            <div class="col-md-3">
                                <span class="input-group">
                                    <input type="text" id="txtProcessCode" disabled="disabled" class="form-control" ng-model="mdlMRP_Dispatch.ProcessCode" placeholder="PROCESS CODE" autocomplete="off" />
                                    <input type="hidden" id="txtProcessAuto" class="form-control" ng-model="mdlMRP_Dispatch.ProcessAuto" autocomplete="off" />

                                    <span>
                                        <button ng-click="SearchProcess()" ng-hide="IsEdit" tabindex="2" type="button" id="btnSearchProcess" class="btn btn-primary pull-right" style="padding: 3.5px 10px;"><i class="fa fa-search"></i></button>
                                    </span>
                                    <span>
                                        <a href='#' id='btnADDSub' ng-click="WOCheckList();" style='margin-right:5px;'><i class='fa fa-list-alt fa-2x' style='color: #bb893c; font-size: 37px; line-height: 33px;' data-original-title='Add' data-toggle='tooltip'></i></a>
                                    </span>
                                </span>
                            </div>
                            @*<label id="lblitem" class="col-md-2 control-label">Process Name<span style="color:red">*</span></label>*@
                            <div class="col-md-4">
                                <textarea type="text" id="txtProcessName" disabled="disabled" rows="1" class="form-control" ng-model="mdlMRP_Dispatch.ProcessName" placeholder="PROCESS DESCRIPTION" autocomplete="off"></textarea>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div style="overflow:auto; width:100%">
                                <table id="tblDispatchsub" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                    <thead>
                                        <tr style=" background-color: #e1e1e1; color: #650001;">
                                            <th ng-hide='IsViewMode1' style="text-align:center"><a href="#" ng-click="GetSubDetails()" ng-hide='IsViewMode' tabindex="5" id="tblScopeType_Add" style="color:black !important" class="fa fa-plus">Add</a></th>

                                            <th style="text-align:center">WO No</th>
                                            <th style="text-align:center">RM No</th>
                                            <th style="text-align:center">ITEM CODE</th>
                                            <th style="text-align:center">ITEM DESCRITPTION</th>
                                            <th style="text-align:center">QTY</th>
                                            <th style="text-align:center">CASTING WEIGHT / PCS</th>
                                            <th style="text-align:center">TOTAL WEIGHT OF PROD</th>
                                            <th style="text-align:center">REMARK</th>
                                            <th style="text-align:center">EMPLOYEE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in mdlMRP_Dispatch.lstSub| filter : searchtxt">
                                            <td ng-hide='IsViewMode1' style="min-width:90px;" align="center">
                                                <input type="hidden" id="hdnSubId" ng-model="item.SubAutoTrNo" />
                                                <input type="hidden" id="hdnSubWOAuto" ng-model="item.WOSubAuto" />
                                                <input type="hidden" id="hdnPendingQty" ng-model="item.PendingQty" />
                                                <a href='#' id='btnCancel' ng-click="DeleteRow(item);" ng-hide='IsViewMode'><i class='fa fa-trash fa-lg' style='color:#ed4e2a;' data-original-title='Cancel' data-toggle='tooltip'></i></a>
                                                <a href='#' id='btnADDSub' ng-click="CheckList($index);" style='margin-right:5px;'><i class='fa fa-list-alt fa-lg' style='color:#bb893c;' data-original-title='Add' data-toggle='tooltip'></i></a>

                                            </td>
                                            <td style="min-width:120px;">
                                                <span class="input-group">
                                                    <input type='Text' ng-model="item.WONo" class='form-control' id='txtSWONo' autocomplete="off" placeholder="WO NO" disabled="disabled"><input type='hidden' id='hiddenLedgerID' value='' />

                                                    <input type="hidden" id="ROWID" ng-model="item.ROWID" value="" />
                                                    <input type="hidden" id="hdnmMACSubAuto" ng-model="item.WOAuto" value="" />
                                                </span>
                                            </td>
                                            <td style="min-width:120px;">
                                                <span class="input-group">
                                                    <input type='Text' ng-model="item.RMNo" class='form-control' id='txtRMNo' autocomplete="off" placeholder="RM NO" disabled="disabled">
                                                    <input type="hidden" id="hdnmRMAuto" ng-model="item.RMAuto" value="" />
                                                </span>
                                            </td>
                                            <td style="min-width:120px;">
                                                <input type='Text' ng-model="item.SItemCode" class='form-control' id='txtSItemCode' autocomplete="off" placeholder=" ITEM CODE" style="text-align:left" disabled="disabled">
                                                <input type="hidden" id="hdnSubItemAuto" ng-model="item.SItemAuto" value="" />
                                            </td>
                                            <td style="min-width:250px;">
                                                <textarea ng-model="item.SItemDescription" class='form-control' val='' id='txtSItemDescription' autocomplete="off" placeholder="ITEM DESCRIPTION" disabled="disabled"></textarea>
                                            </td>
                                            <td style="width: 100px; min-width: 80px;">

                                                <input type='Text' ng-model="item.Qty" ng-disabled="IsViewMode" ng-change="ChekPendingQty(item)" class='form-control' onkeypress="NumberOnly()" id='txtQty' autocomplete="off" placeholder="QUANTITY" style="text-align:right">
                                            </td>
                                            <td style="width: 100px; min-width: 80px;">

                                                <input type='Text' ng-model="item.CastingWeight" disabled="disabled" onkeypress="NumberOnly()" class='form-control' id='txtCastingWeight' autocomplete="off" placeholder="Casting Weight" style="text-align:right">
                                            </td>
                                            <td style="width: 100px; min-width: 80px;">

                                                <input type='Text' ng-model="item.TotalWeight" disabled="disabled" class='form-control' id='txtTotalWeight' autocomplete="off" placeholder="Total Weight" style="text-align:right">
                                            </td>
                                            <td style="min-width:120px;">
                                                <input type='Text' style="text-align:right" ng-model="item.Remarks" ng-disabled="IsViewMode" class='form-control' id='txtRemarks' autocomplete="off" placeholder="REMARKS">
                                            </td>
                                            <td style="min-width:200px;">
                                                <span class="input-group">
                                                    <input type='Text' ng-model="item.EmployeeName" class='form-control' id='txtSEmp' autocomplete="off" placeholder="EMPLOYEE" disabled="disabled"><input type='hidden' id='hiddenLedgerID' value='' />
                                                    <span>
                                                        <button type="button" ng-click="SearchEmployee()" id="btnEmp" class="btn btn-primary pull-right" ng-hide='IsViewMode' style="padding: 3.5px 10px;"><i class="fa fa-search"></i></button>
                                                    </span>
                                                    <input type="hidden" id="ROWID" ng-model="item.ROWID" value="" />
                                                    <input type="hidden" id="hdnmEmpSubAuto" ng-model="item.EmployeeAuto" value="" />
                                                </span>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tabDoc">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label id="lblHsncode" style="font-size:larger;" class="control-label">Document Attachment</label>
                            </div>
                            <div style="overflow:auto" class="col-md-12">
                                <table id="tblClientDoc" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                    <thead>
                                        <tr style="background-color: #e1e1e1; color: #650001;">
                                            <th ng-hide='IsViewMode' style="text-align:center;min-width:80px"><a href="#" ng-click="GetClientDoc()" tabindex="9" ng-hide="IsViewMode" id="tblClientDoc_Add" style="color:black !important" class="fa fa-plus">Add</a></th>
                                            <th style="text-align:center">Name</th>
                                            <th style="text-align:center">Document  </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in mdlMRP_Dispatch.lstClientDoc| filter : searchtxt">
                                            <td ng-hide='IsViewMode' style="min-width:80px;" align="center"><a href='#' tabindex="9" id='btnCancel' ng-click="DeleteDocClientRow(item);" ng-hide="IsViewMode"><i class='fa fa-trash fa-lg' style='color:#ed4e2a;' data-original-title='Cancel' data-toggle='tooltip'></i></a></td>
                                            <td style="min-width:200px;"><input type='Text' tabindex="9" ng-model="item.Name" ng-disabled="IsViewMode" class='form-control' val='' id='txtName'><input type='hidden' ng-model="item.AutoTrNo" id='hdnScopeTypeID' value='' /></td>
                                            <td style="min-width:300px;">
                                                <button ng-show="item.hide" tabindex="9" class='btn btn-primary' type='button' id='btnClientDoc'><i class=''></i>Upload</button>
                                                <input type='file' id='flClientDoc' style='display: none; opacity: 0; height: 0px; width: 0px;' />
                                                <a ng-show="item.IsViewRemove" tabindex="9" style="margin-right:4px;" id="btnClientDocCancel">
                                                    <i class="fa fa-trash fa-sm" style="color:#ed4e2a;" data-original-title="Cancel" data-toggle="tooltip"></i>
                                                </a>
                                                @*<a style='color: #bb893c;font-size: 13px;' href='#' ng-model="item.OriginalDocName" id='lnkProductCatalogueName' target='blank'></a>*@
                                                <a ng-disabled="IsViewMode" style='color: #bb893c;font-size: 13px;' href='{{item.DocName}}' id='lnkProductCatalogueName' target='blank'>{{item.OriginalDocName}}</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tabIns">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label id="lblHsncode" style="font-size:larger;" class="control-label">Insurance Attachment</label>
                            </div>
                            <div style="overflow:auto" class="col-md-12">
                                <table id="tblClientIns" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                    <thead>
                                        <tr style="background-color: #e1e1e1; color: #650001;">
                                            <th ng-hide='IsViewMode' style="text-align:center;min-width:80px"><a href="#" ng-click="GetClientIns()" tabindex="9" ng-hide="IsViewMode" id="tblClientIns_Add" style="color:black !important" class="fa fa-plus">Add</a></th>
                                            <th style="text-align:center">Name</th>
                                            <th style="text-align:center">Document  </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in mdlMRP_Dispatch.lstClientIns| filter : searchtxt">
                                            <td ng-hide='IsViewMode' style="min-width:80px;" align="center"><a href='#' tabindex="9" id='btnCancel' ng-click="DeleteInsClientRow(item);" ng-hide="IsViewMode"><i class='fa fa-trash fa-lg' style='color:#ed4e2a;' data-original-title='Cancel' data-toggle='tooltip'></i></a></td>
                                            <td style="min-width:200px;"><input type='Text' tabindex="9" ng-model="item.Name" ng-disabled="IsViewMode" class='form-control' val='' id='txtName'><input type='hidden' ng-model="item.AutoTrNo" id='hdnScopeTypeID' value='' /></td>
                                            <td style="min-width:300px;">
                                                <button ng-show="item.hide" tabindex="9" class='btn btn-primary' type='button' id='btnClientIns'><i class=''></i>Upload</button>
                                                <input type='file' id='flClientIns' style='display: none; opacity: 0; height: 0px; width: 0px;' />
                                                <a ng-show="item.IsViewRemove" tabindex="9" style="margin-right:4px;" id="btnClientInsCancel">
                                                    <i class="fa fa-trash fa-sm" style="color:#ed4e2a;" data-original-title="Cancel" data-toggle="tooltip"></i>
                                                </a>
                                                @*<a style='color: #bb893c;font-size: 13px;' href='#' ng-model="item.OriginalDocName" id='lnkProductCatalogueName' target='blank'></a>*@
                                                <a ng-disabled="IsViewMode" style='color: #bb893c;font-size: 13px;' href='{{item.DocName}}' id='lnkProductCatalogueName' target='blank'>{{item.OriginalDocName}}</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tabShip">
                        <div class="form-group row">
                            <div class="col-md-12">
                                <label id="lblHsncode" style="font-size:larger;" class="control-label">Shipping Attachment</label>
                            </div>
                            <div style="overflow:auto" class="col-md-12">
                                <table id="tblClientShipAtt" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                    <thead>
                                        <tr style="background-color: #e1e1e1; color: #650001;">
                                            <th ng-hide='IsViewMode' style="text-align:center;min-width:80px"><a href="#" ng-click="GetClientShipAtt()" tabindex="9" ng-hide="IsViewMode" id="tblClientShipAtt_Add" style="color:black !important" class="fa fa-plus">Add</a></th>
                                            <th style="text-align:center">Name</th>
                                            <th style="text-align:center">Document  </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in mdlMRP_Dispatch.lstClientShipAtt| filter : searchtxt">
                                            <td ng-hide='IsViewMode' style="min-width:80px;" align="center"><a href='#' tabindex="9" id='btnCancel' ng-click="DeleteShipClientRow(item);" ng-hide="IsViewMode"><i class='fa fa-trash fa-lg' style='color:#ed4e2a;' data-original-title='Cancel' data-toggle='tooltip'></i></a></td>
                                            <td style="min-width:200px;"><input type='Text' tabindex="9" ng-model="item.Name" ng-disabled="IsViewMode" class='form-control' val='' id='txtName'><input type='hidden' ng-model="item.AutoTrNo" id='hdnScopeTypeID' value='' /></td>
                                            <td style="min-width:300px;">
                                                <button ng-show="item.hide" tabindex="9" class='btn btn-primary' type='button' id='btnClientShipAtt'><i class=''></i>Upload</button>
                                                <input type='file' id='flClientShipAtt' style='display: none; opacity: 0; height: 0px; width: 0px;' />
                                                <a ng-show="item.IsViewRemove" tabindex="9" style="margin-right:4px;" id="btnClientShipAttCancel">
                                                    <i class="fa fa-trash fa-sm" style="color:#ed4e2a;" data-original-title="Cancel" data-toggle="tooltip"></i>
                                                </a>
                                                @*<a style='color: #bb893c;font-size: 13px;' href='#' ng-model="item.OriginalDocName" id='lnkProductCatalogueName' target='blank'></a>*@
                                                <a ng-disabled="IsViewMode" style='color: #bb893c;font-size: 13px;' href='{{item.DocName}}' id='lnkProductCatalogueName' target='blank'>{{item.OriginalDocName}}</a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tabPack">
                        <div class="form-group row">
                            <div style="overflow:auto; width:100%">
                                <table id="tblPackaging" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                    <thead>
                                        <tr style=" background-color: #e1e1e1; color: #650001;">
                                            <th ng-hide='IsViewMode1' style="text-align:center"><a href="#" ng-click="AddPackaging()" ng-hide='IsViewMode' tabindex="5" style="color:black !important" class="fa fa-plus">Add</a></th>
                                            <th style="text-align:center">Item Code</th>
                                            <th style="text-align:center">Item Description</th>
                                            <th style="text-align:center">Packing Type</th>
                                            <th style="text-align:center">Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in mdlMRP_Dispatch.lstPackaging | filter : searchtxt">
                                            <td ng-hide='IsViewMode1' style="min-width:90px;" align="center">
                                                <input type="hidden" id="hdnSubPAutoTrNo" ng-model="item.PAutoTrNo" />
                                                <a href='#' id='btnCancel' ng-click="PackagingDeleteRow(item);" ng-hide='IsViewMode'><i class='fa fa-trash fa-lg' style='color:#ed4e2a;' data-original-title='Cancel' data-toggle='tooltip'></i></a>
                                            </td>
                                            <td style="min-width:200px;">
                                                <span class="input-group">
                                                    <input type='Text' ng-model="item.PItemCode" class='form-control' id='txtPItemCode' autocomplete="off" placeholder="Item Code " disabled="disabled">
                                                    <span>
                                                        <button type="button" id="btnSearchItem" class="btn btn-primary pull-right" style="padding: 3.5px 10px;" ng-hide='IsViewMode'><i class="fa fa-search"></i></button>
                                                    </span>
                                                    <input type="hidden" id="hdnpItemAuto" ng-model="item.PItemAuto" value="0" />

                                                </span>
                                            </td>
                                            <td style="min-width:120px;">
                                                <input type='Text' ng-model="item.PItemName" class='form-control' id='txtPItemName' autocomplete="off" placeholder="ITEM NAME" disabled="disabled">
                                            </td>
                                            <td style="min-width:120px;">
                                                <input type='Text' ng-model="item.PackingType" ng-disabled="IsViewMode" class='form-control' id='txtPackingType' autocomplete="off" placeholder="PACKING TYPE">
                                            </td>
                                            <td style="min-width:120px;">
                                                <input type='Text' ng-model="item.PQty" ng-disabled="IsViewMode" onkeypress="NumberOnly()" class='form-control' id='txtPQty' autocomplete="off" placeholder="QTY" style="text-align:right">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tabTrnspo">
                        <div class="form-group row">
                            <label id="lblHsncode" class="col-md-1 control-label">TRANSPORT COMPANY</label>
                            <div class="col-md-3">
                                <input type="text" id="txtTcomp" ng-disabled="IsViewMode" ng-model="mdlMRP_Dispatch.TransportCompany" class="form-control" placeholder="TRANSPORT COMPANY" autocomplete="off" disabled="disabled" />
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">MODE OF TRANSPORT</label>
                            <div class="col-md-3">
                                <input type="text" id="txtTMode" ng-disabled="IsViewMode" ng-model="mdlMRP_Dispatch.TransportMode" class="form-control" placeholder="MODE OF TRANSPORT" autocomplete="off" disabled="disabled" />
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">LR NO</label>
                            <div class="col-md-3">
                                <input type="text" id="txtLRNo" ng-disabled="IsViewMode" ng-model="mdlMRP_Dispatch.LRNo" class="form-control" placeholder="LR NO" autocomplete="off" disabled="disabled" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label id="lblHsncode" class="col-md-1 control-label">Outward Date</label>
                            <div class="col-md-2">
                                <input type="text" id="txtODate" ng-disabled="IsViewMode" ng-model="mdlMRP_Dispatch.OutwardDate" style="text-align:center;" class="form-control" placeholder="DC DATE" autocomplete="off" />
                            </div>
                            <label id="lblHsncode" class="col-md-1 control-label">Vehicle No</label>
                            <div class="col-md-3">
                                <input type="text" id="txtLRNo" ng-disabled="IsViewMode" ng-model="mdlMRP_Dispatch.VehicleNo" class="form-control" placeholder="VEHICLE NO" autocomplete="off" disabled="disabled" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label id="lblitem" class="col-md-1 control-label">Remarks</label>
                            <div class="col-md-11">
                                <textarea id="txtRemarks" ng-model="mdlMRP_Dispatch.TRemarks" placeholder="REMARKS" class="form-control" rows="2" ng-disabled="IsViewMode"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="PartyModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Party Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> <span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <table id="tblParty" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap">
                                    <thead>
                                        <tr>
                                            <th style="text-align:center">SRNO</th>
                                            <th style="text-align:center">Party Code</th>
                                            <th style="text-align:center">Party Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="dataTables_empty">Record not found </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th></th>
                                            <th>PARTY CODE</th>
                                            <th>PARTY NAME</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="EmployeeModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Employee Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> <span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="overflow:auto">
                                    <table id="tblEmployee" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">SR NO</th>
                                                <th style="text-align:center">Employee Code</th>
                                                <th style="text-align:center">Employee Name</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="dataTables_empty">Record not found </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th></th>
                                                <th>EMPLOYEE CODE</th>
                                                <th>EMPLOYEE NAME</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="WOModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        WO Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> <span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="overflow:auto">
                                    <table id="tblWO" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">SR NO</th>
                                                <th style="text-align:center">WO No</th>
                                                <th style="text-align:center">WO Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="dataTables_empty">Record not found </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th></th>
                                                <th>WO NO</th>
                                                <th>WO Date</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ItemModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Item Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="overflow:auto">
                                    <table id="tblItem" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">SR NO</th>
                                                <th style="text-align:center">Item Code</th>
                                                <th style="text-align:center">Item Name</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="dataTables_empty">Record not found </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th></th>
                                                <th>ITEM CODE</th>
                                                <th>ITEM Name</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="WOItemModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Wo Item Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> <span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="overflow:auto">
                                    <table id="tblWOItems" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">SR NO</th>
                                                <th style="text-align:center">WO No</th>
                                                <th style="text-align:center">RM No</th>
                                                <th style="text-align:center">Item Code</th>
                                                <th style="text-align:center">Item Description</th>
                                                <th style="text-align:center">Qty</th>
                                                <th style="text-align:center">Pending Qty</th>


                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5" class="dataTables_empty">Record not found </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th></th>
                                                <th>WO NO</th>
                                                <th>RM No</th>
                                                <th>ITEM CODE</th>
                                                <th>ITEM DESCRIPTION</th>
                                                <th>QTY</th>
                                                <th>Pending QTY</th>

                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input ng-hide="IsViewMode" type="button" id="btnUpdateClause" ng-click="SaveWoItemSub()" class="btn btn-primary width100 " value="Save" />
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="ProcessModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Process Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"> <span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <table id="tblProcess" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap">
                                    <thead>
                                        <tr>
                                            <th style="text-align:center">SRNO</th>
                                            <th style="text-align:center">Process Code</th>
                                            <th style="text-align:center">Process Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="5" class="dataTables_empty">Record not found </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th></th>
                                            <th>Process CODE</th>
                                            <th>Process NAME</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!--<div class="modal fade" id="OCCheckListModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Check Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group row">
                                    <div style="overflow:auto; width:100%">
                                        <input type="hidden" ng-model="ChekListIndex" id="" />
                                        <table id="tblOCChekList" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                            <thead>
                                                <tr style=" background-color: #e1e1e1; color: #650001;">
                                                    <th style="text-align:center">Check List</th>
                                                    <th style="text-align:center"></th>
                                                </tr>
                                            </thead>
                                            <tbody>-->
    @*<tr ng-repeat="item in InspectionChekList | filter : searchtxt">
            <td style="min-width:200px;">
                <input type="hidden" id="hdnSubAutoTrNo" ng-model="item.AutoTrNo" />

                <input type='Text' ng-model="item.CheckListDesc" class='form-control' id='txtCheckListDesc' autocomplete="off" placeholder="Check List" disabled="disabled">
                <input type="hidden" id="hdnProcessAuto" ng-model="item.CheckListAuto" value="0" />
                <input type="hidden" id="hdnSubAuto" ng-model="item.SubAuto" value="" />
                <input type="hidden" id="hdnSubAuto" ng-model="item.ProcessAuto" value="" />
                <input type="hidden" id="hdnMainAuto" ng-model="item.MainAuto" value="" />
                <input type="hidden" id="hdnAutoTrNo" ng-model="item.AutoTrNo" value="" />

            </td>
            <td style="min-width:120px; text-align:center">
                <input type='checkbox' ng-model="item.IsChecked" ng-disabled="IsViewMode" autocomplete="off">
            </td>
        </tr>*@
    <!--</tbody>
    </table>-->
    @*<table id="tblOCChekList" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
            <thead>
                <tr style=" background-color: #e1e1e1; color: #650001;">
                    <th style="text-align:center">Check List</th>
                    <th style="text-align:center"></th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="item in InspectionChekList | filter : searchtxt">
                    <td style="min-width:200px;">
                        <input type="hidden" id="hdnSubAutoTrNo" ng-model="item.AutoTrNo" />

                        <input type='Text' ng-model="item.CheckListDesc" class='form-control' id='txtCheckListDesc' autocomplete="off" placeholder="Check List" disabled="disabled">
                        <input type="hidden" id="hdnProcessAuto" ng-model="item.CheckListAuto" value="0" />
                        <input type="hidden" id="hdnSubAuto" ng-model="item.SubAuto" value="" />
                        <input type="hidden" id="hdnSubAuto" ng-model="item.ProcessAuto" value="" />
                        <input type="hidden" id="hdnMainAuto" ng-model="item.MainAuto" value="" />
                        <input type="hidden" id="hdnAutoTrNo" ng-model="item.AutoTrNo" value="" />

                    </td>
                    <td style="min-width:120px; text-align:center">
                        <input type='checkbox' ng-model="item.IsChecked" ng-disabled="IsViewMode" autocomplete="off">
                    </td>
                </tr>
            </tbody>
        </table>*@
    <!--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnSaveProcess" ng-click="SaveCheckList()" ng-hide="IsViewMode" class="btn btn-primary" data-dismiss="modal">Save</button>
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>-->

    <div class="modal fade" id="OCCheckListModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Check Details
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span aria-hidden="true"></span></button>
                </div>
                <div class="modal-body">
                    <div class=" col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group row">
                                    <div style="overflow:auto; width:100%">

                                        <table id="tblOCChekList" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                            <thead>
                                                <tr style=" background-color: #e1e1e1; color: #650001;">
                                                    <th style="text-align:center">Check List</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="item in lstCheckList | filter : searchtxt">
                                                    <td style="min-width:200px;">
                                                        <input type="hidden" id="hdnSubAutoTrNo" ng-model="item.AutoTrNo" />

                                                        <input type='Text' ng-model="item.CheckListDesc" class='form-control' id='txtCheckListDesc' autocomplete="off" placeholder="Check List" disabled="disabled">
                                                        <input type="hidden" id="hdnProcessAuto" ng-model="item.CheckListAuto" value="0" />
                                                        <input type="hidden" id="hdnSubAuto" ng-model="item.SubAuto" value="" />
                                                        <input type="hidden" id="hdnSubAuto" ng-model="item.SubSubAuto" value="" />
                                                        <input type="hidden" id="hdnMainAuto" ng-model="item.MainAuto" value="" />
                                                        <input type="hidden" id="hdnAutoTrNo" ng-model="item.AutoTrNo" value="" />

                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnSaveProcess" ng-hide="IsViewMode" ng-click="SaveCheckList()" class="btn btn-primary" data-dismiss="modal">Save</button>
                    <button type="button" id="btnItemCancel" class="btn btn-default width100" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal " id="BillListModal" tabindex="-1" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-xl" style="width: 80%">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Select Bill Series
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                </div>
                <div class="modal-body">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div style="overflow:auto">
                                    <table id="tblBillList" cellpadding="0" cellspacing="0" border="0" class="table table-bordered table-hover nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th style="text-align:center">SR No</th>
                                                <th style="text-align:center">Entry Type</th>
                                                <th style="text-align:center">Last No</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="100" class="dataTables_empty">No record found to match the criteria</td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th></th>
                                                <th>Entry Type</th>
                                                <th>Last No</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="btnCancelClause" class="btn btn-default width100" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    jQuery(document).ready(function () {
        $('#txtDate').datetimepicker({
            format: 'DD/MM/YYYY',
        });
        $('#txtODate').datetimepicker({
            format: 'DD/MM/YYYY',
        });

    });
    function NumberOnly() {
        var AsciiValue = event.keyCode
        if ((AsciiValue >= 48 && AsciiValue <= 57) || (AsciiValue == 8 || AsciiValue == 127) || AsciiValue == 43 || AsciiValue == 46) {

            event.returnValue = true;
        }
        else {
            event.returnValue = false;
        }

    }
</script>

